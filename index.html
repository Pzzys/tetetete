<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loryez</title>
    <link rel="icon" type="image/x-icon" href="https://styles.redditmedia.com/t5_6xhgie/styles/communityIcon_8kgc2fy21dcb1.jpeg?width=128&frame=1&auto=webp&s=2f9049eda6789be694672b93c66064e8007c11bf">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@300;400;500;600;700&family=Outfit:wght@300;400;500;600&family=Space+Grotesk:wght@400;500;600&family=Comfortaa:wght@700&family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@400;500;600;700&family=Raleway:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- NOVA PALETA (ROXO E PRETO) E VARIÁVEIS GLOBAIS --- */
        :root {
            --bg-primary: #050505;
            --bg-secondary: #0f0f13;
            --bg-tertiary: #181820;
            --bg-accent: #20202a;
            --text-primary: #f0f2ff;
            --text-secondary: #b8bbd6;
            --text-muted: #8a8da8;
            
            /* Tons de Roxo como base */
            --accent-primary: #9d4edd; /* Roxo vibrante */
            --accent-secondary: #7b2cbf; /* Roxo escuro */
            --accent-tertiary: #c77dff; /* Lilás */
            --accent-glow: rgba(157, 78, 221, 0.15);
            
            --success: #4cda64;
            --warning: #ffb74d;
            --error: #ff5252;
            --info: #448aff;
            --border-thin: 1px solid rgba(255, 255, 255, 0.07);
            --border-medium: 1px solid rgba(255, 255, 255, 0.12);
            --border-thick: 1px solid rgba(255, 255, 255, 0.2);
            --shadow-soft: 0 4px 12px rgba(0, 0, 0, 0.25);
            --shadow-medium: 0 8px 24px rgba(0, 0, 0, 0.3);
            --shadow-glow: 0 0 20px rgba(157, 78, 221, 0.2);
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 14px;
        }

        /* --- RESET E ESTILOS GLOBAIS --- */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            text-rendering: optimizeLegibility;
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(123, 44, 191, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 85% 30%, rgba(157, 78, 221, 0.05) 0%, transparent 50%);
        }
        
        ::-webkit-scrollbar { 
            width: 6px; 
        }
        ::-webkit-scrollbar-track { 
            background: var(--bg-secondary); 
        }
        ::-webkit-scrollbar-thumb { 
            background: var(--accent-primary); 
            border-radius: 3px; 
        }
        ::-webkit-scrollbar-thumb:hover { 
            background: var(--accent-secondary); 
        }

        /* --- NAVEGAÇÃO --- */
        .top-nav {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 18px;
            background-color: rgba(5, 5, 5, 0.9);
            backdrop-filter: blur(12px);
            border-bottom: var(--border-thin);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .nav-link {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            text-decoration: none;
            font-family: 'Comfortaa', sans-serif;
            font-weight: 700;
            font-size: 1.05rem;
            padding: 10px 20px;
            border-radius: var(--radius-md);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .nav-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
            border-radius: var(--radius-md);
        }
        
        .nav-link:hover, .nav-link.active {
            color: var(--text-primary);
            transform: translateY(-2px);
        }
        
        .nav-link.active::before {
            opacity: 1;
        }
        
        .nav-link svg {
            transition: all 0.3s ease;
        }
        
        .nav-link.active svg {
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.5));
        }

        /* --- CONTEÚDO DAS ABAS --- */
        .tab-content {
            padding: 2rem;
        }
        
        .hidden { 
            display: none;
        }

        /* --- LAYOUT PRINCIPAL --- */
        .main-container {
            display: grid;
            grid-template-columns: minmax(0, 2fr) minmax(0, 1.2fr);
            gap: 28px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .column { 
            display: flex; 
            flex-direction: column; 
            gap: 28px; 
        }

        .card { 
            background-color: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 28px;
            border: var(--border-thin);
            box-shadow: var(--shadow-soft);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .card.static {
            transition: none;
        }
        
        .card.static::before {
            display: none;
        }
        
        .card.static:hover {
            transform: none;
            box-shadow: var(--shadow-soft);
        }
        
        .card:hover::before {
            opacity: 1;
        }
        
        .card:hover {
            box-shadow: var(--shadow-medium);
            transform: translateY(-3px);
            border-color: rgba(157, 78, 221, 0.3);
        }

        .full-width { 
            grid-column: 1 / -1;
        }

        h2 { 
            font-family: 'Jost', sans-serif;
            font-size: 1.7rem; 
            font-weight: 700; 
            margin-bottom: 20px;
            letter-spacing: -0.5px;
            color: var(--text-primary);
            position: relative;
            padding-bottom: 10px;
        }
        
        h2::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 40px;
            height: 3px;
            background: linear-gradient(to right, var(--accent-primary), var(--accent-secondary));
            border-radius: 2px;
        }
        
        h3 { 
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.2rem; 
            font-weight: 600; 
            margin-bottom: 12px; 
            color: var(--text-primary); 
        }

        /* --- ABAS DE BUSCA --- */
        .tabs { 
            display: flex;
            gap: 6px; 
            margin-bottom: 20px; 
            background-color: var(--bg-tertiary);
            padding: 6px;
            border-radius: var(--radius-md);
            border: var(--border-thin);
        }
        
        .tab-button {
            background: transparent;
            border: none; 
            color: var(--text-secondary);
            padding: 12px 18px; 
            border-radius: var(--radius-sm); 
            cursor: pointer; 
            transition: all 0.3s ease;
            flex: 1;
            font-weight: 600;
            font-size: 0.95rem;
            font-family: 'Space Grotesk', sans-serif;
            position: relative;
            overflow: hidden;
        }
        
        .tab-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
            border-radius: var(--radius-sm);
        }
        
        .tab-button.active { 
            color: var(--text-primary);
            transform: translateY(-2px);
        }
        
        .tab-button.active::before {
            opacity: 1;
        }
        
        .tab-button:not(.active):hover {
            background-color: var(--bg-accent);
            color: var(--text-primary);
        }

        /* --- BUSCA E RESULTADOS --- */
        .search-wrapper { 
            position: relative;
        }
        
        #search-input { 
            width: 100%;
            background-color: var(--bg-tertiary); 
            border: var(--border-medium); 
            border-radius: var(--radius-md); 
            padding: 16px 20px;
            color: var(--text-primary); 
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: 'Outfit', sans-serif;
        }
        
        #search-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px var(--accent-glow);
        }
        
        #search-results-list {
            position: absolute;
            top: 100%; 
            left: 0; 
            right: 0; 
            background-color: var(--bg-tertiary);
            border: var(--border-medium); 
            border-top: none; 
            border-radius: 0 0 var(--radius-md) var(--radius-md);
            z-index: 10;
            max-height: 300px; 
            overflow-y: auto;
            box-shadow: var(--shadow-medium);
        }
        
        .search-result-item { 
            padding: 14px 18px;
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 14px; 
            transition: all 0.2s ease;
            border-bottom: var(--border-thin);
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        .search-result-item:hover { 
            background-color: var(--bg-accent);
        }
        
        .search-result-item img { 
            width: 40px;
            height: 60px; 
            object-fit: cover; 
            border-radius: var(--radius-sm); 
        }
        
        .search-result-item p { 
            font-weight: 500;
            font-family: 'Space Grotesk', sans-serif;
        }
        
        .search-result-item span { 
            font-size: 0.85rem;
            color: var(--text-muted); 
        }

        /* --- PREVIEW E BOTÃO CONTINUAR --- */
        #search-preview.card { 
            margin-top: 20px;
            display: flex; 
            flex-direction: column;
            gap: 20px;
        }
        
        .preview-content { 
            display: flex;
            gap: 20px; 
        }
        
        .preview-content .poster { 
            width: 180px;
            height: 270px; 
            object-fit: cover; 
            border-radius: var(--radius-md); 
            flex-shrink: 0; 
            box-shadow: var(--shadow-soft);
        }
        
        .preview-content .synopsis { 
            font-size: 0.95rem;
            margin-top: 12px; 
            line-height: 1.6;
            max-height: 140px;
            overflow-y: auto; 
            color: var(--text-secondary); 
            padding-right: 8px;
        }
        
        .continue-button, .pay-button, .retry-btn {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: var(--text-primary); 
            border: none; 
            border-radius: var(--radius-md); 
            padding: 16px 24px; 
            font-weight: 600; 
            font-size: 1rem;
            cursor: pointer; 
            transition: all 0.3s ease;
            text-align: center;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-decoration: none;
            font-family: 'Jost', sans-serif;
            box-shadow: var(--shadow-soft);
            position: relative;
            overflow: hidden;
        }
        
        .continue-button::before, .pay-button::before, .retry-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }
        
        .continue-button:hover::before, .pay-button:hover::before, .retry-btn:hover::before {
            left: 100%;
        }
        
        .continue-button:hover, .pay-button:hover, .retry-btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-glow);
        }

        .retry-btn {
            margin-top: 16px;
            background: var(--bg-tertiary);
            border: var(--border-thin);
            width: auto;
            min-width: 200px;
            margin-left: auto;
            margin-right: auto;
        }

        .retry-btn:hover {
            background: var(--bg-accent);
            border-color: var(--accent-primary);
        }

        /* --- OPÇÕES DE CONFIGURAÇÃO --- */
        .classificacao-box {
            border-left: 3px solid var(--accent-primary);
            background: linear-gradient(90deg, rgba(157, 78, 221, 0.1), transparent);
            border-radius: 0 var(--radius-md) var(--radius-md) 0; 
            padding: 18px; 
            margin-bottom: 20px;
        }
        
        .classificacao-box p { 
            font-size: 1rem;
            margin-bottom: 8px; 
            font-family: 'Space Grotesk', sans-serif;
        }
        
        .classificacao-box span { 
            font-size: 0.9rem;
            color: var(--warning);
            display: block;
            margin-top: 8px;
        }
        
        .config-group { 
            margin-bottom: 28px;
        }
        
        .checkbox-group label {
            display: flex;
            align-items: center; 
            gap: 12px; 
            padding: 14px;
            font-size: 0.95rem; 
            cursor: pointer;
            border-radius: var(--radius-md);
            transition: background-color 0.2s ease;
            border: var(--border-thin);
        }
        
        .checkbox-group label:hover { 
            background-color: var(--bg-accent);
        }

        input[type="checkbox"] {
           appearance: none;
           width: 22px; 
           height: 22px; 
           border: 2px solid var(--border-medium);
           border-radius: var(--radius-sm); 
           background-color: var(--bg-tertiary); 
           cursor: pointer; 
           position: relative; 
           transition: all 0.2s ease;
        }
        
        input[type="checkbox"]:checked { 
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-color: transparent; 
            transform: scale(1.05);
        }
        
        input[type="checkbox"]:checked::after { 
            content: '✔';
            position: absolute; 
            color: white; 
            font-size: 14px;
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%);
        }

        .select-input {
            width: 100%;
            background-color: var(--bg-tertiary); 
            border: var(--border-medium);
            border-radius: var(--radius-md); 
            padding: 14px; 
            color: var(--text-primary); 
            font-size: 0.95rem;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23b8bbd6' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1em;
            transition: all 0.2s ease;
            font-family: 'Outfit', sans-serif;
        }
        
        .select-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }
        
        .number-input-wrapper { 
            display: flex;
            justify-content: space-between; 
            align-items: center; 
            padding: 0 12px; 
            background-color: var(--bg-tertiary);
            border-radius: var(--radius-md);
            border: var(--border-medium);
        }
        
        .number-input-wrapper input { 
            background: none;
            border: none;
            outline: none; 
            color: var(--text-primary); 
            text-align: center; 
            width: 50px; 
            font-size: 1rem;
            font-family: 'Space Grotesk', sans-serif;
        }
        
        .num-btn { 
            background: none;
            border: none; 
            color: var(--text-secondary); 
            font-size: 1.5rem; 
            cursor: pointer; 
            padding: 0 8px; 
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .num-btn:hover { 
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        /* --- RESUMO --- */
        #summary-content .poster { 
            width: 80px;
            height: 120px; 
            object-fit: cover; 
            border-radius: var(--radius-md); 
            box-shadow: var(--shadow-soft);
        }
        
        #price-breakdown { 
            padding: 16px 0;
        }
        
        #price-breakdown p { 
            display: flex;
            justify-content: space-between; 
            color: var(--text-secondary); 
            font-size: 0.95rem; 
            margin-bottom: 12px; 
            padding: 8px 0;
            border-bottom: var(--border-thin);
        }
        
        #price-breakdown p:last-child {
            border-bottom: none;
        }
        
        .divider { 
            height: 1px;
            background: linear-gradient(to right, transparent, var(--accent-primary), transparent); 
            margin: 16px 0; 
        }
        
        .total { 
            display: flex;
            justify-content: space-between; 
            align-items: baseline; 
            padding-top: 16px; 
        }
        
        .total .total-text { 
            font-size: 1.3rem;
            font-weight: 600; 
            font-family: 'Jost', sans-serif;
        }
        
        .total .price { 
            font-family: 'Jost', sans-serif;
            font-size: 2rem;
            font-weight: 700; 
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 10px rgba(157, 78, 221, 0.3);
        }
        
        #pay-button { 
            margin-top: 24px;
        }

        .pay-button.disabled { 
            background: var(--bg-tertiary);
            color: var(--text-muted);
            cursor: not-allowed; 
            transform: none;
            box-shadow: none;
        }
        
        .pay-button.disabled:hover { 
            background: var(--bg-tertiary);
            transform: none;
            box-shadow: none;
        }
        
        .pay-button.disabled::before {
            display: none;
        }
        
        .placeholder { 
            padding: 16px;
            color: var(--text-muted); 
            text-align: center; 
            font-style: italic; 
        }

        /* --- CAIXA DE INFORMAÇÕES --- */
        .info-box {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, var(--bg-tertiary), var(--bg-accent));
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-top: 16px;
            border: var(--border-thin);
            position: relative;
        }
        
        .info-box ul {
            padding-left: 20px;
            color: var(--text-secondary);
            font-size: 0.95rem;
            line-height: 1.8;
        }
        
        .info-box li {
            margin-bottom: 8px;
            position: relative;
        }
        
        .info-box li::before {
            content: '▶';
            position: absolute;
            left: -18px;
            color: var(--accent-primary);
            font-size: 0.8rem;
        }
        
        .nudez-episodes-config {
            margin-top: 16px;
            padding: 16px;
            background-color: var(--bg-tertiary);
            border-radius: var(--radius-md);
            border: var(--border-medium);
        }
        
        .change-button {
            background: transparent;
            border: var(--border-medium);
            color: var(--accent-primary);
            padding: 8px 16px;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s;
            font-family: 'Space Grotesk', sans-serif;
        }
        
        .change-button:hover {
            background-color: var(--accent-primary);
            color: var(--text-primary);
            border-color: var(--accent-primary);
        }
        
        .nudez-checkbox { 
            border: 2px solid var(--accent-primary) !important;
        }

        /* --- AVISOS E NOTIFICAÇÕES --- */
        .discount-notice, .warning-notice, .error-notice, .list-info-notice {
            font-size: 0.9rem;
            margin-top: 8px;
            font-weight: 500;
            padding: 12px 16px;
            border-radius: var(--radius-md);
            border-left: 4px solid;
            font-family: 'Space Grotesk', sans-serif;
        }
        
        .discount-notice {
            color: var(--success);
            background: linear-gradient(90deg, rgba(76, 218, 100, 0.1), transparent);
            border-color: var(--success);
        }
        
        .warning-notice {
            color: var(--warning);
            background: linear-gradient(90deg, rgba(255, 183, 77, 0.1), transparent);
            border-color: var(--warning);
        }
        
        .error-notice {
            color: var(--error);
            background: linear-gradient(90deg, rgba(255, 82, 82, 0.1), transparent);
            border-color: var(--error);
        }
        
        .list-info-notice {
            color: var(--info);
            background: linear-gradient(90deg, rgba(68, 138, 255, 0.1), transparent);
            border-color: var(--info);
        }
        
        .media-info {
            color: var(--text-muted) !important;
            font-size: 0.9rem;
            margin-top: 4px;
        }
        
        .info-content {
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            padding: 18px;
            margin-bottom: 20px;
        }
        
        .studio-list, .release-info {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1rem;
            margin-top: 8px;
            line-height: 1.5;
            font-weight: 500;
        }
        
        .studio-list { 
            color: var(--accent-primary);
        }
        
        .release-info { 
            color: var(--accent-tertiary);
        }

        /* --- LISTA DE EPISÓDIOS --- */
        .content-info-spacing { 
            margin: 20px 0;
        }
        
        .option-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
            font-family: 'Space Grotesk', sans-serif;
        }
        
        .episode-selector {
            margin-top: 16px;
            border: var(--border-medium);
            border-radius: var(--radius-md);
            padding: 16px;
            background-color: var(--bg-tertiary);
        }
        
        .episode-item {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
            padding: 12px;
            border-radius: var(--radius-sm);
            transition: background-color 0.2s;
            gap: 12px;
            border-bottom: var(--border-thin);
        }
        
        .episode-item:last-child {
            border-bottom: none;
        }
        
        .episode-item:hover { 
            background-color: var(--bg-accent);
        }
        
        .episode-info { 
            flex: 1;
        }
        
        .episode-duration {
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-left: 12px;
        }
        
        .nudez-warning {
            color: var(--warning);
            margin-top: 8px;
            font-weight: 500;
        }
        
        .episode-scroll-container {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 12px;
            padding-right: 8px;
        }
        
        .grito-notice {
            background: linear-gradient(90deg, rgba(255, 215, 0, 0.1), transparent);
            border-left: 4px solid gold;
            border-radius: 0 var(--radius-md) var(--radius-md) 0;
            padding: 16px 20px;
            margin: 20px 0;
            font-size: 1rem;
            color: gold;
            text-align: center;
            font-weight: 600;
            font-family: 'Jost', sans-serif;
        }

        /* --- NOVO SISTEMA DE LOADING --- */
        .loading-progress {
            display: none;
            width: 100%;
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 12px;
            position: relative;
        }
        
        .loading-progress.active {
            display: block;
        }
        
        .loading-progress-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-tertiary));
            border-radius: 2px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .loading-progress-text {
            position: absolute;
            top: -24px;
            right: 0;
            font-size: 0.85rem;
            color: var(--text-muted);
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 500;
        }
        
        .loading-stages {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .loading-stage {
            text-align: center;
            flex: 1;
            padding: 4px;
            transition: all 0.3s ease;
        }
        
        .loading-stage.active {
            color: var(--accent-primary);
            font-weight: 600;
        }
        
        .loading-stage.completed {
            color: var(--success);
        }
        
        .continue-button.loading {
            position: relative;
            pointer-events: none;
            opacity: 0.8;
        }
        
        .continue-button.loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            opacity: 0.7;
            z-index: 1;
        }
        
        /* Estilos do loading rápido */
        .quick-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(5, 5, 8, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .quick-loading.active {
            opacity: 1;
            visibility: visible;
        }
        
        .quick-loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(157, 78, 221, 0.2);
            border-radius: 50%;
            border-top-color: var(--accent-primary);
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        .quick-loading-text {
            font-size: 1.2rem;
            color: var(--text-primary);
            font-weight: 600;
            margin-bottom: 8px;
            font-family: 'Jost', sans-serif;
        }
        
        .quick-loading-subtext {
            font-size: 0.9rem;
            color: var(--text-muted);
            max-width: 300px;
            text-align: center;
            line-height: 1.4;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .already-sponsored {
            color: var(--success);
            font-weight: 500;
            margin-left: 8px;
            font-size: 0.85rem;
        }
        
        /* --- NOVOS ESTILOS PARA OS NÚMEROS --- */
        .episode-number {
            font-family: 'Jost', sans-serif;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .episode-label {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        /* --- CÓDIGO ADICIONADO: LOADING SPINNER NO BOTÃO (MANTIDO PARA COMPATIBILIDADE) --- */
        .continue-button .spinner {
            display: none;
            width: 22px;
            height: 22px;
            border: 4px solid var(--text-primary);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .continue-button.is-loading {
            cursor: wait;
        }

        .continue-button.is-loading .spinner {
            display: inline-block;
        }

        .continue-button.is-loading .button-text {
            display: none;
        }

        /* --- NOVOS ESTILOS - ABA "PATROCINADOS" --- */
        .sponsored-section {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .sponsored-section h2 {
            border-left: 4px solid var(--accent-primary);
            padding-left: 16px;
            margin-bottom: 24px;
        }
        
        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 24px;
            margin-bottom: 48px;
        }
        
        .media-card {
            background-color: var(--bg-secondary);
            border-radius: var(--radius-md);
            overflow: hidden;
            border: var(--border-thin);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        
        .media-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 3px;
            height: 100%;
            background: linear-gradient(to bottom, var(--accent-primary), var(--accent-secondary));
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .media-card:hover::before {
            opacity: 1;
        }
        
        .media-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-glow);
            border-color: var(--accent-primary);
        }
        
        .media-card img {
            width: 100%;
            height: auto;
            display: block;
            aspect-ratio: 2 / 3;
            object-fit: cover;
        }
        
        .media-card-title {
            padding: 14px;
            font-size: 0.9rem;
            font-weight: 600;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-family: 'Space Grotesk', sans-serif;
        }
        
        #loading-message, #assistidos-loading-message {
            text-align: center;
            font-size: 1.2rem;
            color: var(--text-muted);
            margin-top: 50px;
        }
        
        .error-container {
            text-align: center;
            padding: 40px;
            background: rgba(255, 82, 82, 0.05);
            border-radius: var(--radius-md);
            border: 1px solid rgba(255, 82, 82, 0.2);
            margin-top: 20px;
        }

        .error-container p {
            color: var(--error);
            margin-bottom: 16px;
            font-weight: 500;
        }

        /* --- ESTILOS PARA BUSCA NA ABA PATROCINADOS --- */
        .sponsored-search-controls {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            position: relative;
        }

        .sponsored-search-controls .search-wrapper {
            flex-grow: 1;
        }

        #sponsored-search-input {
            width: 100%;
            background-color: var(--bg-tertiary);
            border: var(--border-medium);
            border-radius: var(--radius-md);
            padding: 14px 20px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: 'Outfit', sans-serif;
        }

        #sponsored-search-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px var(--accent-glow);
        }
        
        .filter-wrapper {
            position: relative;
        }

        #filter-toggle-btn {
            height: 100%;
            padding: 0 16px;
            background-color: var(--bg-tertiary);
            border: var(--border-medium);
            color: var(--text-secondary);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #filter-toggle-btn:hover, #filter-toggle-btn.active {
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        #filter-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background-color: var(--bg-tertiary);
            border: var(--border-medium);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-medium);
            z-index: 100;
            overflow: hidden;
            width: 150px;
        }
        
        #filter-dropdown.hidden {
            display: none;
        }

        .filter-option {
            display: block;
            padding: 12px 16px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.95rem;
            transition: background-color 0.2s;
            cursor: pointer;
        }

        .filter-option:hover {
            background-color: var(--bg-accent);
            color: var(--text-primary);
        }
        
        .filter-option.active {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: var(--text-primary);
            font-weight: 600;
        }

        /* --- NOVOS ESTILOS PARA A ABA ASSISTIDOS --- */
        .stars-rating {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 8px;
        }
        
        .star {
            color: var(--text-muted);
            font-size: 1.2rem;
        }
        
        .star.filled {
            color: var(--warning);
        }
        
        .star.half {
            position: relative;
            color: var(--text-muted);
        }
        
        .star.half::before {
            content: '★';
            position: absolute;
            left: 0;
            width: 50%;
            overflow: hidden;
            color: var(--warning);
        }
        
        .no-rating {
            color: var(--text-muted);
            font-style: italic;
            font-size: 0.9rem;
        }

        /* --- CORREÇÕES PARA A ABA ASSISTIDOS --- */
        .assistidos-search-controls {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            position: relative;
        }

        .assistidos-search-controls .search-wrapper {
            flex-grow: 1;
        }

        #assistidos-search-input {
            width: 100%;
            background-color: var(--bg-tertiary);
            border: var(--border-medium);
            border-radius: var(--radius-md);
            padding: 14px 20px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: 'Outfit', sans-serif;
        }

        #assistidos-search-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px var(--accent-glow);
        }

        #assistidos-filter-toggle-btn {
            height: 100%;
            padding: 0 16px;
            background-color: var(--bg-tertiary);
            border: var(--border-medium);
            color: var(--text-secondary);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #assistidos-filter-toggle-btn:hover, #assistidos-filter-toggle-btn.active {
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        #assistidos-filter-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background-color: var(--bg-tertiary);
            border: var(--border-medium);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-medium);
            z-index: 100;
            overflow: hidden;
            width: 150px;
        }
        
        #assistidos-filter-dropdown.hidden {
            display: none;
        }

        /* --- MODAIS DO PRIMEIRO CÓDIGO (ADAPTADOS) --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(5, 5, 8, 0.9);
            backdrop-filter: blur(10px);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s ease;
            padding: 20px;
        }
        
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
            border-radius: 20px;
            border: 1px solid rgba(157, 78, 221, 0.2);
            max-width: 820px;
            width: 90%;
            max-height: 90vh;
            display: flex;
            flex-direction: column; 
            padding: 28px; 
            position: relative;
            transform: scale(0.95);
            transition: all 0.4s ease;
            box-shadow: 0 0 20px rgba(157, 78, 221, 0.5);
            overflow: hidden;
        }
        
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }

        .modal-header {
            margin-bottom: 20px;
            width: 100%;
            padding-right: 40px; 
        }

        .modal-title {
            font-family: 'Raleway', sans-serif;
            font-size: 1.6rem; 
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--text-primary);
            text-shadow: none;
            line-height: 1.2;
        }

        .modal-subtitle {
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem;
            color: #888; 
            font-weight: 500;
        }
        
        .modal-body {
            display: flex;
            gap: 24px;
            overflow: hidden;
            flex: 1;
        }
        
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.5rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            background: transparent; 
            width: auto;
            height: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        
        .modal-close:hover {
            color: var(--text-primary);
            transform: scale(1.1);
        }
        
        .modal-poster img {
            width: 220px; 
            height: auto;
            aspect-ratio: 2 / 3;
            object-fit: cover;
            border-radius: 12px;
            flex-shrink: 0;
            box-shadow: var(--shadow-soft);
            border: none; 
        }
        
        .modal-details {
            overflow-y: auto;
            padding-right: 8px;
            flex-grow: 1;
        }
        
        .modal-meta {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
            color: var(--text-muted);
            font-weight: 500;
            flex-wrap: wrap;
        }
        
        .modal-meta span {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.15); 
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
        }
        
        .modal-info-group {
            margin-bottom: 16px; 
        }
        
        .modal-info-group strong {
            display: block;
            color: var(--text-primary);
            margin-bottom: 6px;
            font-size: 0.95rem; 
            font-family: 'Montserrat', sans-serif;
        }
        
        .modal-info-group p {
            color: var(--text-secondary);
            line-height: 1.5;
            font-size: 0.9rem; 
            text-align: justify;
        }
        
        .modal-genres {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
         
        .modal-genres span {
            background: rgba(157, 78, 221, 0.1);
            border: var(--border-thin);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
        }

        .stars-rating {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 6px;
        }
        
        .star {
            color: var(--text-muted);
            font-size: 1.1rem; 
        }
        
        .star.filled {
            color: var(--warning);
        }
        
        .star.half {
            position: relative;
            color: var(--text-muted);
        }
        
        .star.half::before {
            content: '★';
            position: absolute;
            left: 0;
            width: 50%;
            overflow: hidden;
            color: var(--warning);
        }
        
        .no-rating {
            color: var(--text-muted);
            font-style: italic;
            font-size: 0.85rem;
        }

        .info-tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px; 
            margin-top: 4px;
        }
        
        .info-tag {
            background: rgba(157, 78, 221, 0.1);
            border: var(--border-thin);
            padding: 4px 10px; 
            border-radius: var(--radius-sm);
            font-size: 0.85rem; 
            color: var(--text-secondary);
            font-weight: 500;
            line-height: 1.4;
        }

        /* BACKDROP DO TMDB */
        .modal-backdrop-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center top;
            opacity: 0.15;
            z-index: -1;
            filter: blur(2px);
            border-radius: 20px;
            pointer-events: none;
        }

        /* --- RESPONSIVIDADE --- */
        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .media-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                gap: 20px;
            }
        }

        @media (max-width: 768px) {
            .top-nav {
                flex-direction: column;
                gap: 10px;
                padding: 12px;
            }
            
            .nav-link {
                width: 100%;
                justify-content: center;
            }
            
            .tab-content {
                padding: 1rem;
            }
            
            .main-container {
                gap: 16px;
            }
            
            .card {
                padding: 20px;
            }
            
            .media-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 16px;
            }
            
            .sponsored-search-controls,
            .assistidos-search-controls {
                flex-direction: column;
            }
            
            .filter-wrapper {
                align-self: flex-end;
            }
            
            .preview-content {
                flex-direction: column;
                text-align: center;
            }
            
            .preview-content .poster {
                width: 140px;
                height: 210px;
                margin: 0 auto;
            }
            
            /* Modais responsivos */
            .modal-content {
                padding: 20px;
                height: auto;
                max-height: 95vh;
            }
            
            .modal-body {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }
            
            .modal-poster img {
                width: 160px;
                margin-bottom: 16px;
            }
            
            .modal-meta, .modal-genres {
                justify-content: center;
            }
            
            .modal-header {
                padding-right: 0;
                text-align: center;
            }
            
            .modal-title {
                font-size: 1.4rem;
            }
            
            .quick-loading-text {
                font-size: 1rem;
            }
            
            .quick-loading-subtext {
                font-size: 0.8rem;
                padding: 0 16px;
            }
        }

        @media (max-width: 480px) {
            .tab-content {
                padding: 0.5rem;
            }
            
            .card {
                padding: 16px;
            }
            
            h2 {
                font-size: 1.4rem;
            }
            
            h3 {
                font-size: 1.1rem;
            }
            
            .media-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 12px;
            }
            
            .media-card-title {
                padding: 10px;
                font-size: 0.8rem;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab-button {
                padding: 10px;
            }
            
            .modal-content {
                padding: 16px;
            }
            
            .modal-poster img {
                width: 140px;
            }
            
            .modal-title {
                font-size: 1.2rem;
            }
            
            .quick-loading-spinner {
                width: 50px;
                height: 50px;
            }
            
            .quick-loading-text {
                font-size: 0.9rem;
            }
        }

        @media (max-width: 360px) {
            .media-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
            
            .modal-poster img {
                width: 120px;
            }
            
            .modal-content {
                padding: 12px;
            }
        }

        /* --- ANIMAÇÕES ADICIONAIS --- */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .card, .media-card {
            animation: fadeIn 0.5s ease-out;
        }
    </style>
</head>
<body>

    <!-- Loading Rápido (Oculto por padrão) -->
    <div id="quick-loading" class="quick-loading">
        <div class="quick-loading-spinner"></div>
        <div class="quick-loading-text">Carregando informações...</div>
        <div class="quick-loading-subtext">Isso levará apenas alguns segundos</div>
    </div>

    <nav class="top-nav">
        <!-- Ícone alterado para $ SVG -->
        <a class="nav-link active" data-tab="patrocinar">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                <path d="M4 10.781c.148 1.667 1.513 2.85 3.591 3.003V15h1.043v-1.216c2.27-.179 3.678-1.438 3.678-3.3 0-1.59-.947-2.51-2.956-3.028l-.722-.187V3.467c1.122.11 1.879.714 2.07 1.616h1.47c-.166-1.6-1.54-2.748-3.54-2.875V1H7.591v1.233c-1.939.23-3.27 1.472-3.27 3.156 0 1.454.966 2.483 2.661 2.917l.61.162v4.031c-1.149-.17-1.94-.8-2.131-1.718H4zm3.391-3.836c-1.043-.263-1.6-.825-1.6-1.616 0-.944.704-1.641 1.8-1.828v3.495l-.2-.05zm1.591 1.872c1.287.323 1.852.859 1.852 1.769 0 1.097-.826 1.828-2.2 1.939V8.73l.348.086z"/>
            </svg>
            Patrocinar
        </a>
       
         <a class="nav-link" data-tab="patrocinados">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM6.79 5.093A.5.5 0 0 0 6 5.5v5a.5.5 0 0 0 .79.407l3.5-2.5a.5.5 0 0 0 0-.814l-3.5-2.5z"/></svg>
            Patrocinados
        </a>
        
        <!-- ABA: ASSISTIDOS -->
        <a class="nav-link" data-tab="assistidos">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                <path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0z"/>
                <path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8zm8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/>
            </svg>
            Assistidos
        </a>
    </nav>

    <main>
        <div id="patrocinar-tab" class="tab-content">
           
         <div class="main-container">
                <div class="column">
                    <div id="search-block" class="card static">
                        <h2>Buscar</h2>
                        <div class="tabs">
                          <button class="tab-button active" data-type="movie">Filme</button>
                            <button class="tab-button" data-type="tv">Série/Anime</button>
                        </div>
                        <div class="search-wrapper">
                            <input type="text" id="search-input" placeholder="Pesquisar filme">
                            <div id="search-results-list" class="hidden"></div>
                        </div>
                      <div id="search-preview" class="card hidden"></div>
                    </div>
                    <div id="config-block" class="card static hidden">
                        <div id="config-options"></div>
                    </div>
                </div>
                <div class="column">
                    <div class="card static">
                        <h2>Resumo do Patrocínio</h2>
                        <div id="summary-placeholder" class="placeholder">Configure as opções para ver o preço</div>
                        <div id="summary-content" class="hidden">
                            <div style="display: flex; gap: 16px;">
                                <img class="poster" id="summary-poster" src="" alt="Poster">
                                <div> 
                                    <h3 id="summary-title"></h3> 
                                    <p id="summary-info" class="media-info"></p> 
                                </div>
                            </div>
                            <div class="divider"></div>
                            <div id="price-breakdown"></div>
                            <div class="divider"></div>
                            <div class="total">
                                <p class="total-text">Total:</p>
                                <p class="price" id="total-price">R$ 0,00</p>
                            </div>
                            <a id="pay-button" href="https://livepix.gg/loryez" target="_blank" class="pay-button">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M8.636 3.5a.5.5 0 0 0-.5-.5H1.5A1.5 1.5 0 0 0 0 4.5v10A1.5 1.5 0 0 0 1.5 16h10a1.5 1.5 0 0 0 1.5-1.5V7.864a.5.5 0 0 0-1 0V14.5a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5h6.636a.5.5 0 0 0 .5-.5"/>
                                    <path fill-rule="evenodd" d="M16 .5a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0 0 1h3.793L6.146 9.146a.5.5 0 1 0 .708.708L15 1.707V5.5a.5.5 0 0 0 1 0z"/>
                                </svg>
                                Pagar no LivePix
                            </a>
                            <div id="restriction-warning" class="error-notice hidden" style="margin-top: 16px;"></div>
                        </div>
                    </div>
                </div>
                <div class="info-box">
                    <h3>Informações importantes:</h3>
                    <ul>
                        <li>Para séries e animes, é necessário patrocinar pelo menos 3 episódios</li>
                        <li>Materiais que precisarem de censura (nudez), não será possível transmiti-lo imediatamente. Data do filme a combinar com o patrocinador!</li>
                    </ul>
                </div>
            </div>
        </div>

        <div id="patrocinados-tab" class="tab-content hidden">
            <div class="sponsored-section">
                <div class="sponsored-search-controls">
                    <div class="search-wrapper">
                        <input type="text" id="sponsored-search-input" placeholder="Pesquisar em patrocinados...">
                    </div>
                    <div class="filter-wrapper">
                        <button id="filter-toggle-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M1.5 1.5A.5.5 0 0 1 2 1h12a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.128.334L10 8.692V13.5a.5.5 0 0 1-.74.439L7 12.439V8.692L1.628 3.834A.5.5 0 0 1 1.5 3.5v-2z"/>
                            </svg>
                        </button>
                        <div id="filter-dropdown" class="hidden">
                            <a class="filter-option active" data-filter="all">Todos</a>
                            <a class="filter-option" data-filter="filmes">Filmes</a>
                            <a class="filter-option" data-filter="series">Séries</a>
                            <a class="filter-option" data-filter="animes">Animes</a>
                        </div>
                    </div>
                </div>

                <div id="loading-message">Carregando conteúdos patrocinados...</div>
                
                <div id="filmes-section" class="hidden">
                    <h2>Filmes Patrocinados</h2>
                    <div id="filmes-grid" class="media-grid"></div>
                </div>
 
                <div id="series-section" class="hidden">
                    <h2>Séries Patrocinadas</h2>
                    <div id="series-grid" class="media-grid"></div>
                </div>

                <div id="animes-section" class="hidden">
                    <h2>Animes Patrocinados</h2>
                    <div id="animes-grid" class="media-grid"></div>
                </div>
            </div>
        </div>
        
        <!-- ABA: ASSISTIDOS -->
        <div id="assistidos-tab" class="tab-content hidden">
            <div class="sponsored-section">
                <div class="assistidos-search-controls">
                    <div class="search-wrapper">
                        <input type="text" id="assistidos-search-input" placeholder="Pesquisar em assistidos...">
                    </div>
                    <div class="filter-wrapper">
                        <button id="assistidos-filter-toggle-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M1.5 1.5A.5.5 0 0 1 2 1h12a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.128.334L10 8.692V13.5a.5.5 0 0 1-.74.439L7 12.439V8.692L1.628 3.834A.5.5 0 0 1 1.5 3.5v-2z"/>
                            </svg>
                        </button>
                        <div id="assistidos-filter-dropdown" class="hidden">
                            <a class="filter-option active" data-filter="all">Todos</a>
                            <a class="filter-option" data-filter="filmes">Filmes</a>
                            <a class="filter-option" data-filter="series">Séries</a>
                            <a class="filter-option" data-filter="animes">Animes</a>
                        </div>
                    </div>
                </div>

                <div id="assistidos-loading-message">Carregando conteúdos assistidos...</div>
                
                <div id="assistidos-filmes-section" class="hidden">
                    <h2>Filmes Assistidos</h2>
                    <div id="assistidos-filmes-grid" class="media-grid"></div>
                </div>
 
                <div id="assistidos-series-section" class="hidden">
                    <h2>Séries Assistidas</h2>
                    <div id="assistidos-series-grid" class="media-grid"></div>
                </div>

                <div id="assistidos-animes-section" class="hidden">
                    <h2>Animes Assistidos</h2>
                    <div id="assistidos-animes-grid" class="media-grid"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- MODAIS DO PRIMEIRO CÓDIGO (ADAPTADOS) -->
    <div id="details-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-backdrop-bg"></div>
            <button class="modal-close">&times;</button>
            <div class="modal-header">
                <h2 id="modal-title" class="modal-title"></h2>
                <div id="modal-subtitle" class="modal-subtitle"></div>
            </div>
            
            <div class="modal-body">
                <div class="modal-poster">
                    <img id="modal-poster" src="" alt="Pôster do conteúdo">
                </div>
                <div class="modal-details">
                    <div id="modal-meta" class="modal-meta"></div>
                    
                    <div id="modal-info-tv" class="hidden">
                        <div id="modal-total-eps-group" class="modal-info-group hidden">
                            <strong>Episódios Totais:</strong>
                             <div id="modal-total-eps" class="info-tag-container"></div>
                        </div>
                        <div class="modal-info-group">
                            <strong>Episódios Patrocinados:</strong>
                             <div id="modal-sponsored-eps" class="info-tag-container"></div>
                        </div>
                        <div class="modal-info-group">
                            <strong>Episódios Assistidos:</strong>
                            <div id="modal-watched-eps" class="info-tag-container"></div>
                       </div>
                    </div>

                    <div class="modal-info-group" id="modal-sponsor-container-body">
                        <strong>Patrocinador:</strong>
                        <div id="modal-sponsor" class="info-tag-container"></div>
                     </div>

                    <div class="modal-info-group">
                        <strong>Sinopse:</strong>
                        <p id="modal-synopsis"></p>
                    </div>
                 
                    <div id="modal-genres-container" class="modal-info-group hidden">
                        <strong>Gêneros:</strong>
                        <div id="modal-genres" class="modal-genres"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
   
    <div id="assistidos-details-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-backdrop-bg"></div>
            <button class="modal-close">&times;</button>
            <div class="modal-header">
                <h2 id="assistidos-modal-title" class="modal-title"></h2>
                <div id="assistidos-modal-subtitle" class="modal-subtitle"></div>
            </div>

            <div class="modal-body">
                <div class="modal-poster">
                    <img id="assistidos-modal-poster" src="" alt="Pôster do conteúdo">
                </div>
                <div class="modal-details">
                    <div id="assistidos-modal-meta" class="modal-meta"></div>
                    
                    <div id="assistidos-modal-info-tv" class="hidden">
                        <div class="modal-info-group">
                            <strong>Episódios Patrocinados:</strong>
                            <div id="assistidos-modal-sponsored-eps" class="info-tag-container"></div>
                        </div>
                        <div class="modal-info-group">
                            <strong>Episódios Assistidos:</strong>
                            <div id="assistidos-modal-watched-eps" class="info-tag-container"></div>
                        </div>
                    </div>

                    <div class="modal-info-group" id="assistidos-modal-sponsor-container-body">
                        <strong>Patrocinador:</strong>
                        <div id="assistidos-modal-sponsor" class="info-tag-container"></div>
                    </div>

                    <div class="modal-info-group">
                        <strong>Nota da Lorena:</strong>
                        <div id="assistidos-modal-rating" class="stars-rating"></div>
                    </div>

                    <div class="modal-info-group">
                        <strong>Sinopse:</strong>
                        <p id="assistidos-modal-synopsis"></p>
                    </div>
                 
                    <div id="assistidos-modal-genres-container" class="modal-info-group hidden">
                        <strong>Gêneros:</strong>
                        <div id="assistidos-modal-genres" class="modal-genres"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- SCRIPT DA ABA PATROCINAR ---
        const API_KEY = 'ae110c8706fa5b6ed0a58125648e31b3';
        const BASE_URL = 'https://api.themoviedb.org/3';
        const IMG_URL = 'https://image.tmdb.org/t/p/w500';
        const BACKDROP_URL = 'https://image.tmdb.org/t/p/original';

        const gritoIds = ["1970", "465086", "11838", "9666", "1975", "382602", "1977", "259233", "400703", "103445", "376788", "199766", "199774", "36917", "26693", "32250", "44203", "347946", "1192702"];
        
        // ARRAY DINÂMICO DE NUDEZ (SERÁ PREENCHIDO PELA URL)
        let nudezIds = [];
        
        // URL DO GOOGLE APPS SCRIPT PARA LISTA DE NUDEZ
        const NUDEZ_LIST_URL = 'https://script.google.com/macros/s/AKfycbwOxm_qIqkfQl9JOOo89y7fueg1CMEj7yIwYatBAOWQf1HYUfYBehNUYbDuKpEewANaNg/exec';

        // URL DO GOOGLE APPS SCRIPT PARA INFORMAÇÕES DE PATROCÍNIO
        const SPONSORED_DATA_URL = 'https://script.google.com/macros/s/AKfycbxrevz030R4hOUV9ZGz4ZRbnM5cX8CIbK5o271i2v0Ve-pKxubTNRYtSQJ3_qVkW3KR/exec';
        // URL DO GOOGLE APPS SCRIPT PARA INFORMAÇÕES DE ASSISTIDOS
        const ASSISTIDOS_DATA_URL = 'https://script.google.com/macros/s/AKfycbxAJoMiHQQy7WbhbWd0ukyXQp34W3zbULqOb6bwW-TfDtGrfw7-iGBoStSyIX1IVyGM6g/exec';
        
        const state = {
            mediaType: 'movie',
            selectedItem: null,
            tempItem: null,
            options: {
                season: 1,
                episodes: 3,
                selectedEpisodes: [],
                nudez: false,
                nudezEpisodes: 0,
            },
            derived: { 
                tvType: 'series', 
                episodeCount: 0,
                seasonEpisodes: 0,
                seasonEpisodesData: [],
                hasNudez: false,
                ageRating: 'Classificação não encontrada',
                ageRatingDescription: 'Não foi possível determinar a classificação indicativa',
                discountNotice: '',
                warningNotice: '',
                productionCompanies: [],
                releaseDate: '',
                temNudezEspecial: false,
                isGrito: false,
                totalEpisodes: 0,
                listInfo: {
                    loading: false,
                    sponsoredEpisodes: 0,
                    watchedEpisodes: 0,
                    currentSeasonSponsored: 0,
                    isCurrentSeasonFullySponsored: false,
                    lastSponsoredEpisode: 0,
                    hasTemporadas: false,
                    temporadasPatrocinadas: [],
                    temporadasAssistidas: [],
                    totalPatrocinados: 0,
                    totalAssistidos: 0
                }
            }
        };
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);
        
        // Sistema de Loading Otimizado
        class LoadingSystem {
            constructor() {
                this.quickLoading = $('#quick-loading');
                this.stages = [
                    'Buscando detalhes...',
                    'Verificando classificação...',
                    'Carregando temporada...',
                    'Calculando preços...'
                ];
                this.currentStage = 0;
            }
            
            show() {
                this.quickLoading.classList.add('active');
                this.updateStage(0);
            }
            
            hide() {
                this.quickLoading.classList.remove('active');
                this.currentStage = 0;
            }
            
            updateStage(index) {
                this.currentStage = index;
                const text = this.stages[index] || 'Finalizando...';
                $('.quick-loading-text').textContent = text;
            }
            
            progress(percent) {
                const bar = $('.loading-progress-bar');
                if (bar) {
                    bar.style.width = `${percent}%`;
                    $('.loading-progress-text').textContent = `${Math.round(percent)}%`;
                }
            }
        }
        
        const loadingSystem = new LoadingSystem();
        
        function init() {
            $$('.tab-button').forEach(tab => tab.addEventListener('click', selectTab));
            $('#search-input').addEventListener('input', handleSearchInput);
            
            // CARREGAR TUDO AUTOMATICAMENTE AO INICIAR
            fetchNudezIds();
            loadSponsoredContent();
            loadAssistidosContent();
            
            // Sistema de abas
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => { 
                    e.preventDefault(); 
                    switchTab(link.dataset.tab); 
                });
            });
        }

        function switchTab(tabName) {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.toggle('active', link.dataset.tab === tabName);
            });
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('hidden', content.id !== `${tabName}-tab`);
            });
        }

        async function fetchNudezIds() {
            try {
                const response = await fetch(NUDEZ_LIST_URL);
                const text = await response.text();
                let data;
                try {
                    data = JSON.parse(text);
                    if (typeof data === 'string') {
                        data = JSON.parse(data);
                    }
                } catch (e) {
                    console.error("Erro no parse JSON de nudez:", e);
                    return;
                }

                if (Array.isArray(data)) {
                    nudezIds = data.map(item => item["IDS DE FILMES COM NUDEZ"].toString());
                    console.log("Lista de nudez carregada:", nudezIds.length, "itens.");
                }
            } catch (error) {
                console.error("Erro ao buscar lista de nudez:", error);
            }
        }

        function selectTab(event) {
            $$('.tab-button').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            state.mediaType = event.target.dataset.type;
            $('#search-input').placeholder = state.mediaType === 'movie' ? 'Pesquisar filme' : 'Pesquisar série ou anime';
            resetToSearch();
        }

        let searchTimeout;
        function handleSearchInput() {
            clearTimeout(searchTimeout);
            $('#search-preview').classList.add('hidden');
            const query = $('#search-input').value.trim();
            if (query.length > 2) {
                searchTimeout = setTimeout(() => searchMedia(query), 300);
            } else {
                $('#search-results-list').classList.add('hidden');
            }
        }

        async function searchMedia(query) {
            const endpoint = `${BASE_URL}/search/${state.mediaType}?api_key=${API_KEY}&query=${encodeURIComponent(query)}&language=pt-BR&include_adult=false`;
            const response = await fetch(endpoint);
            const data = await response.json();
            renderSearchResults(data.results);
        }

        function renderSearchResults(results) {
            const list = $('#search-results-list');
            list.innerHTML = '';
            if (results && results.length > 0) {
                results.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'search-result-item';
                    const title = item.title || item.name;
                    const year = (item.release_date || item.first_air_date)?.split('-')[0] || '';
                    div.innerHTML = `
                        <img src="${item.poster_path ? IMG_URL + item.poster_path : 'https://via.placeholder.com/40x60/333333/ffffff?text=No+Image'}" alt="poster">
                        <div>
                            <p>${title}</p>
                            <span>${year}</span>
                        </div>
                    `;
                    div.addEventListener('click', () => showPreview(item));
                    list.appendChild(div);
                });
                list.classList.remove('hidden');
            } else {
                list.classList.add('hidden');
            }
        }
        
        function showPreview(item) {
            state.tempItem = item;
            $('#search-results-list').classList.add('hidden');
            const title = item.title || item.name;
            const year = (item.release_date || item.first_air_date)?.split('-')[0] || '';
            $('#search-preview').innerHTML = `
                <div class="preview-content">
                    <img src="${item.poster_path ? IMG_URL + item.poster_path : 'https://via.placeholder.com/180x270/333333/ffffff?text=No+Image'}" class="poster">
                    <div>
                        <h3>${title}</h3> 
                        <p class="media-info">${year}</p>
                        <p class="synopsis">${item.overview || 'Sinopse não disponível.'}</p>
                    </div>
                </div>
                <button class="continue-button">
                    <span class="button-text">Continuar</span>
                </button>
                <div class="loading-progress hidden">
                    <div class="loading-progress-bar"></div>
                    <div class="loading-progress-text">0%</div>
                </div>
            `;
            $('#search-preview').classList.remove('hidden');
            
            $('#search-preview .continue-button').addEventListener('click', async (event) => {
                const button = event.currentTarget;
                const loadingProgress = $('.loading-progress');
                
                button.classList.add('loading');
                button.disabled = true;
                loadingProgress.classList.remove('hidden');
                loadingSystem.show();
                loadingSystem.progress(10);

                try {
                    await selectItem(item.id);
                } catch (error) {
                    console.error("Erro ao selecionar o item:", error);
                    button.classList.remove('loading');
                    button.disabled = false;
                    loadingProgress.classList.add('hidden');
                    loadingSystem.hide();
                }
            });
        }

        async function selectItem(id) {
            loadingSystem.updateStage(0);
            loadingSystem.progress(20);
            
            state.options = {
                season: 1,
                episodes: 3,
                selectedEpisodes: [],
                nudez: false,
                nudezEpisodes: 0,
            };
            
            // Buscar detalhes principais
            const endpoint = `${BASE_URL}/${state.mediaType}/${id}?api_key=${API_KEY}&language=pt-BR`;
            const response = await fetch(endpoint);
            state.selectedItem = await response.json();
            
            loadingSystem.updateStage(1);
            loadingSystem.progress(40);
            
            if (state.mediaType === 'tv') {
                state.derived.totalEpisodes = state.selectedItem.number_of_episodes || 0;
            }
            
            if (state.selectedItem.id === 325789) {
                state.selectedItem.runtime = 126;
            }
            if (state.selectedItem.id === 15003) {
                state.selectedItem.runtime = 93;
            }

            state.derived.isGrito = gritoIds.includes(state.selectedItem.id.toString());
            state.derived.temNudezEspecial = !state.derived.isGrito && nudezIds.includes(state.selectedItem.id.toString());
            
            // Executar múltiplas tarefas em paralelo para melhor performance
            const tasks = [];
            
            // Tarefa 1: Classificação
            tasks.push(fetchContentRating().then(() => {
                loadingSystem.progress(50);
            }));
            
            // Tarefa 2: Informações de produção
            tasks.push(getProductionInfo());
            
            if (state.mediaType === 'tv') {
                const isAnimation = state.selectedItem.genres.some(g => g.id === 16);
                state.derived.tvType = isAnimation ? 'anime' : 'series';
                
                loadingSystem.updateStage(2);
                tasks.push(fetchSeasonDetails().then(() => {
                    loadingSystem.progress(60);
                }));
            }
            
            // Aguardar todas as tarefas paralelas
            await Promise.all(tasks);
            
            state.derived.hasNudez = !state.derived.isGrito && (state.selectedItem.adult || false);
            
            loadingSystem.updateStage(3);
            loadingSystem.progress(70);
            
            // Buscar informações de patrocínio do Google Apps Script
            await fetchSponsoredData();
            
            loadingSystem.progress(90);
            
            switchToConfigView();
            renderConfigOptions();
            calculatePrice();
            
            loadingSystem.progress(100);
            setTimeout(() => {
                loadingSystem.hide();
                const button = $('#search-preview .continue-button');
                const loadingProgress = $('.loading-progress');
                if (button) {
                    button.classList.remove('loading');
                    button.disabled = false;
                }
                if (loadingProgress) {
                    loadingProgress.classList.add('hidden');
                }
            }, 300);
        }

        async function fetchContentRating() {
            let ratingEndpoint;
            if (state.mediaType === 'movie') {
                ratingEndpoint = `${BASE_URL}/movie/${state.selectedItem.id}/release_dates?api_key=${API_KEY}`;
            } else {
                ratingEndpoint = `${BASE_URL}/tv/${state.selectedItem.id}/content_ratings?api_key=${API_KEY}`;
            }
            
            try {
                const response = await fetch(ratingEndpoint);
                const ratingData = await response.json();
                
                let foundRating = false;
                
                if (state.mediaType === 'movie') {
                    const brRelease = ratingData.results.find(r => r.iso_3166_1 === 'BR');
                    if (brRelease && brRelease.release_dates.length > 0 && brRelease.release_dates[0].certification) {
                        state.derived.ageRating = brRelease.release_dates[0].certification;
                        foundRating = true;
                    }
                } else {
                    const brRating = ratingData.results.find(r => r.iso_3166_1 === 'BR');
                    if (brRating && brRating.rating) {
                        state.derived.ageRating = brRating.rating;
                        foundRating = true;
                    }
                }
                
                if (!foundRating) {
                    let usRating = '';
                    if (state.mediaType === 'movie') {
                        const usRelease = ratingData.results.find(r => r.iso_3166_1 === 'US');
                        if (usRelease && usRelease.release_dates.length > 0 && usRelease.release_dates[0].certification) {
                            usRating = usRelease.release_dates[0].certification;
                        }
                    } else {
                        const usRatingObj = ratingData.results.find(r => r.iso_3166_1 === 'US');
                        if (usRatingObj && usRatingObj.rating) {
                            usRating = usRatingObj.rating;
                        }
                    }
                    
                    if (usRating) {
                        state.derived.ageRating = convertForeignRatingToBR(usRating);
                        foundRating = true;
                    }
                }

                if (!foundRating) {
                    for (const countryResult of ratingData.results) {
                        if (countryResult.iso_3166_1 === 'BR' || countryResult.iso_3166_1 === 'US') continue;
                        let foreignRating = '';
                        if (state.mediaType === 'movie') {
                            if (countryResult.release_dates && countryResult.release_dates.length > 0) {
                                const certification = countryResult.release_dates.find(rd => rd.certification)?.certification;
                                if (certification) foreignRating = certification;
                            }
                        } else {
                            if (countryResult.rating) {
                                foreignRating = countryResult.rating;
                            }
                        }

                        if (foreignRating) {
                            const convertedRating = convertForeignRatingToBR(foreignRating);
                            if (convertedRating !== 'Classificação não encontrada') {
                                state.derived.ageRating = convertedRating;
                                foundRating = true;
                                break;
                            }
                        }
                    }
                }
                               
                if (!foundRating) {
                    state.derived.ageRating = 'Classificação não encontrada';
                    state.derived.ageRatingDescription = 'Não foi possível determinar a classificação indicativa';
                    return;
                }
                
                switch(state.derived.ageRating) {
                    case 'L': 
                        state.derived.ageRatingDescription = 'Livre para todos os públicos';
                        break;
                    case '10': 
                        state.derived.ageRatingDescription = 'Não recomendado para menores de 10 anos';
                        break;
                    case '12': 
                        state.derived.ageRatingDescription = 'Não recomendado para menores de 12 anos';
                        break;
                    case '14': 
                        state.derived.ageRatingDescription = 'Não recomendado para menores de 14 anos';
                        break;
                    case '16': 
                        state.derived.ageRatingDescription = 'Não recomendado para menores de 16 anos';
                        break;
                    case '18': 
                        state.derived.ageRatingDescription = 'Não recomendado para menores de 18 anos';
                        break;
                    default: 
                        state.derived.ageRatingDescription = 'Classificação indicativa não encontrada';
                }
            } catch (error) {
                console.error('Erro ao buscar classificação:', error);
                state.derived.ageRating = 'Classificação não encontrada';
                state.derived.ageRatingDescription = 'Não foi possível determinar a classificação indicativa';
            }
        }
        
        function convertForeignRatingToBR(foreignRating) {
            const ratingMap = {
                'G': 'L', 'PG': '10', 'PG-13': '12', 'R': '16', 'NC-17': '18',
                'TV-Y': 'L', 'TV-Y7': '10', 'TV-G': 'L', 'TV-PG': '10', 'TV-14': '14', 'TV-MA': '18',
                'U': 'L', '12A': '12', '15': '16',
                '0': 'L', '6': '10', '12': '12', '16': '16', '18': '18',
                'Tous publics': 'L', '-10': '10', '-12': '12', '-16': '16', '-18': '18',
                'G': 'L', 'PG12': '12', 'R15+': '16', 'R18+': '18',
                'M': '14', 'MA15+': '16', 'R18+': '18', 'X18+': '18',
                '14A': '14', '18A': '18',
                'APTA': 'L', '7': '10',
                'All': 'L', '19': '18'
            };
            return ratingMap[foreignRating] || 'Classificação não encontrada';
        }
        
        async function fetchSeasonDetails() {
            const seasonEndpoint = `${BASE_URL}/tv/${state.selectedItem.id}/season/${state.options.season}?api_key=${API_KEY}&language=pt-BR`;
            const response = await fetch(seasonEndpoint);
            const seasonData = await response.json();
            state.derived.seasonEpisodesData = seasonData.episodes || [];
            
            calculateCurrentSeasonSponsored();
            markSponsoredEpisodes();
            autoSelectNextEpisodes();
            
            if (state.derived.tvType === 'anime') {
                updateAndApplyFreeEpisodes();
            }
        }

        function calculateCurrentSeasonSponsored() {
            const totalSponsored = state.derived.listInfo.hasTemporadas ?
                state.derived.listInfo.totalPatrocinados : 
                state.derived.listInfo.sponsoredEpisodes;
            if (totalSponsored > 0 && state.mediaType === 'tv') {
                const currentSeason = state.options.season;
                let episodesInPreviousSeasons = 0;
                
                for (let i = 1; i < currentSeason; i++) {
                    const prevSeason = state.selectedItem.seasons.find(s => s.season_number === i);
                    if (prevSeason) {
                        episodesInPreviousSeasons += prevSeason.episode_count;
                    }
                }
                
                const episodesInCurrentSeason = state.derived.seasonEpisodesData.length;
                const remainingSponsored = totalSponsored - episodesInPreviousSeasons;
                
                state.derived.listInfo.currentSeasonSponsored = Math.max(0, Math.min(episodesInCurrentSeason, remainingSponsored));
                state.derived.listInfo.isCurrentSeasonFullySponsored = 
                    state.derived.listInfo.currentSeasonSponsored >= episodesInCurrentSeason;
                state.derived.listInfo.lastSponsoredEpisode = episodesInPreviousSeasons + state.derived.listInfo.currentSeasonSponsored;
            } else {
                state.derived.listInfo.currentSeasonSponsored = 0;
                state.derived.listInfo.isCurrentSeasonFullySponsored = false;
                state.derived.listInfo.lastSponsoredEpisode = 0;
            }
        }

        function markSponsoredEpisodes() {
            if (state.derived.listInfo.currentSeasonSponsored > 0 && state.mediaType === 'tv') {
                const sponsoredCount = state.derived.listInfo.currentSeasonSponsored;
                state.derived.seasonEpisodesData.forEach((episode, index) => {
                    if (index < sponsoredCount) {
                        const existingIndex = state.options.selectedEpisodes.findIndex(ep => ep.id === episode.id);
                        
                        if (existingIndex === -1) {
                            state.options.selectedEpisodes.push({
                                id: episode.id,
                                number: episode.episode_number,
                                duration: episode.runtime || 0,
                                isFree: false,
                                addedAutomatically: true,
                                alreadySponsored: true
                            });
                        } else {
                            state.options.selectedEpisodes[existingIndex].alreadySponsored = true;
                        }
                    }
                });
            }
        }

        function autoSelectNextEpisodes() {
            if (state.mediaType === 'tv' && !state.derived.listInfo.isCurrentSeasonFullySponsored) {
                const episodesToSelect = 3;
                let selectedCount = 0;
                
                const nextEpisodeIndex = state.derived.listInfo.currentSeasonSponsored;
                for (let i = nextEpisodeIndex; i < state.derived.seasonEpisodesData.length && selectedCount < episodesToSelect; i++) {
                    const episode = state.derived.seasonEpisodesData[i];
                    const isAlreadySelected = state.options.selectedEpisodes.some(ep => ep.id === episode.id);
                    
                    if (!isAlreadySelected) {
                        state.options.selectedEpisodes.push({
                            id: episode.id,
                            number: episode.episode_number,
                            duration: episode.runtime || 0,
                            isFree: false,
                            addedAutomatically: true,
                            alreadySponsored: false
                        });
                        selectedCount++;
                    }
                }
            }
            
            state.options.episodes = state.options.selectedEpisodes.filter(ep => !ep.alreadySponsored).length;
        }

        // NOVA FUNÇÃO: Buscar dados de patrocínio do Google Apps Script
        async function fetchSponsoredData() {
            state.derived.listInfo.loading = true;
            state.derived.listInfo.sponsoredEpisodes = 0;
            state.derived.listInfo.watchedEpisodes = 0;
            state.derived.listInfo.currentSeasonSponsored = 0;
            state.derived.listInfo.isCurrentSeasonFullySponsored = false;
            state.derived.listInfo.lastSponsoredEpisode = 0;
            state.derived.listInfo.hasTemporadas = false;
            state.derived.listInfo.temporadasPatrocinadas = [];
            state.derived.listInfo.temporadasAssistidas = [];
            state.derived.listInfo.totalPatrocinados = 0;
            state.derived.listInfo.totalAssistidos = 0;

            const currentItemId = state.selectedItem.id.toString();
            const currentItemTitle = state.selectedItem.title || state.selectedItem.name;
            
            try {
                const response = await fetch(SPONSORED_DATA_URL);
                const data = await response.json();
                
                if (data && Array.isArray(data)) {
                    const sponsoredItem = data.find(item => 
                        item["ID DO TMDB"] === parseInt(currentItemId) || 
                        normalizeTitle(item.Titulo) === normalizeTitle(currentItemTitle)
                    );
                    if (sponsoredItem) {
                        processSponsoredData(sponsoredItem);
                    }
                }
            } catch (error) {
                console.error('Erro ao buscar dados de patrocínio:', error);
            } finally {
                state.derived.listInfo.loading = false;
            }
        }

        function processSponsoredData(sponsoredItem) {
            if (sponsoredItem["Episódios Patrocinados"]) {
                const sponsoredEpisodes = sponsoredItem["Episódios Patrocinados"];
                if (typeof sponsoredEpisodes === 'number') {
                    state.derived.listInfo.sponsoredEpisodes = sponsoredEpisodes;
                    state.derived.listInfo.totalPatrocinados = sponsoredEpisodes;
                } else if (typeof sponsoredEpisodes === 'string') {
                    const temporadas = extractTemporadasFromDescription(sponsoredEpisodes);
                    if (temporadas.length > 0) {
                        state.derived.listInfo.hasTemporadas = true;
                        state.derived.listInfo.temporadasPatrocinadas = temporadas;
                        state.derived.listInfo.totalPatrocinados = temporadas.reduce((sum, temp) => sum + temp.episodios, 0);
                    } else {
                        const num = extractEpisodeCount(sponsoredEpisodes);
                        if (num) {
                            state.derived.listInfo.sponsoredEpisodes = num;
                            state.derived.listInfo.totalPatrocinados = num;
                        }
                    }
                }
            }
            
            if (sponsoredItem["Episódios Assistidos"]) {
                const watchedEpisodes = sponsoredItem["Episódios Assistidos"];
                if (typeof watchedEpisodes === 'number') {
                    state.derived.listInfo.watchedEpisodes = watchedEpisodes;
                    state.derived.listInfo.totalAssistidos = watchedEpisodes;
                } else if (typeof watchedEpisodes === 'string') {
                    const temporadas = extractTemporadasFromDescription(watchedEpisodes);
                    if (temporadas.length > 0) {
                        state.derived.listInfo.hasTemporadas = true;
                        state.derived.listInfo.temporadasAssistidas = temporadas;
                        state.derived.listInfo.totalAssistidos = temporadas.reduce((sum, temp) => sum + temp.episodios, 0);
                    } else {
                        const num = extractEpisodeCount(watchedEpisodes);
                        if (num) {
                            state.derived.listInfo.watchedEpisodes = num;
                            state.derived.listInfo.totalAssistidos = num;
                        }
                    }
                }
            }
            
            if (!state.derived.listInfo.hasTemporadas) {
                if (state.derived.listInfo.sponsoredEpisodes > 0) {
                    state.derived.listInfo.totalPatrocinados = state.derived.listInfo.sponsoredEpisodes;
                }
                if (state.derived.listInfo.watchedEpisodes > 0) {
                    state.derived.listInfo.totalAssistidos = state.derived.listInfo.watchedEpisodes;
                }
            }
        }

        function extractTemporadasFromDescription(description) {
            if (!description) return [];
            const temporadasMap = {};
            
            const numeroExtenso = {
                'primeira': 1, 'segunda': 2, 'terceira': 3, 'quarta': 4, 'quinta': 5,
                'sexta': 6, 'sétima': 7, 'oitava': 8, 'nona': 9, 'décima': 10
            };
            
            const partes = description.split(' - ');
            partes.forEach(parte => {
                const regex1 = /(\d+)\s*\(?\s*(\d+)[ª°].*?(?:temporada|temp)/gi;
                let match1;
                while ((match1 = regex1.exec(parte)) !== null) {
                    const episodios = parseInt(match1[1]);
                    const temporada = parseInt(match1[2]);
                    temporadasMap[temporada] = episodios;
                }
                
                const regex2 = /(\d+)\s*da\s*(Primeira|Segunda|Terceira|Quarta|Quinta|Sexta|Sétima|Oitava|Nona|Décima)\s*Temporada/gi;
                let match2;
                while ((match2 = regex2.exec(parte)) !== null) {
                    const episodios = parseInt(match2[1]);
                    const temporadaExtenso = match2[2].toLowerCase();
                    const temporada = numeroExtenso[temporadaExtenso];
                    if (temporada) {
                        temporadasMap[temporada] = episodios;
                    }
                }
            });
            const temporadas = Object.keys(temporadasMap).map(tempNum => ({
                temporada: parseInt(tempNum),
                episodios: temporadasMap[tempNum]
            }));
            return temporadas.sort((a, b) => a.temporada - b.temporada);
        }

        function extractEpisodeCount(description) {
            if (!description) return null;
            const patterns = [
                /(\d+)\s*epis[oó]dios?/i,
                /(\d+)\s*eps?/i,
                /patrocinou\s*(\d+)/i,
                /assistiu\s*(\d+)/i
            ];
            for (const pattern of patterns) {
                const match = description.match(pattern);
                if (match && match[1]) {
                    return parseInt(match[1]);
                }
            }
            return null;
        }

        function normalizeTitle(title) {
            return title
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/[^a-z0-9 ]/g, '')
                .replace(/\s+/g, ' ')
                .trim();
        }

        function getProductionInfo() {
            state.derived.productionCompanies = [];
            if (state.selectedItem.production_companies) {
                state.derived.productionCompanies = state.selectedItem.production_companies.map(company => company.name);
            }
            
            if (state.selectedItem.release_date) {
                const date = new Date(state.selectedItem.release_date);
                state.derived.releaseDate = date.toLocaleDateString('pt-BR');
            } else if (state.selectedItem.first_air_date) {
                const date = new Date(state.selectedItem.first_air_date);
                state.derived.releaseDate = date.toLocaleDateString('pt-BR');
            } else {
                state.derived.releaseDate = 'Data não disponível';
            }
        }
        
        function renderConfigOptions() {
            const infoSep = " ‧ ";
            const year = (state.selectedItem.release_date || state.selectedItem.first_air_date)?.split('-')[0] || 'N/A';
            const movieInfo = `Filme ${infoSep} ${year} ${infoSep} ${formatDuration(state.selectedItem.runtime)}`;
            const tvInfo = `${state.derived.tvType === 'anime' ? 'Anime' : 'Série'} ${infoSep} ${year}`;
            
            let optionsHTML = `<div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>Item Selecionado</h2>
                <button class="change-button" id="change-item">Alterar</button>
            </div>
            <div style="display: flex; gap: 16px; margin-bottom: 24px;">
                <img src="${state.selectedItem.poster_path ? IMG_URL + state.selectedItem.poster_path : 'https://via.placeholder.com/80x120/333333/ffffff?text=No+Image'}" class="poster" style="width: 80px; height: 120px;">
                <div>
                    <h3>${state.selectedItem.title || state.selectedItem.name}</h3>
                    <p class="media-info">${state.mediaType === 'movie' ? movieInfo : tvInfo}</p>
                </div>
            </div>`;
            
            if (state.derived.listInfo.loading) {
                optionsHTML += `<div class="list-info-notice"><span class="loading"></span> Verificando informações de patrocínio...</div>`;
            }

            if (state.mediaType === 'tv' && state.derived.listInfo.isCurrentSeasonFullySponsored) {
                optionsHTML += `
                <div class="warning-notice" style="margin-bottom: 16px;">
                    Esta temporada já foi patrocinada, selecione outra (se disponível) para ver os preços.
                </div>`;
            }

            optionsHTML += `
            <div class="classificacao-box">
                <p><strong>Classificação Indicativa</strong></p>
                <p><strong>${state.derived.ageRating}</strong> - ${state.derived.ageRatingDescription}</p>`;
            if (state.derived.temNudezEspecial) {
                optionsHTML += `<div class="nudez-warning">⚠ Este filme contém nudez</div>`;
            } else if (!state.derived.isGrito && ((state.mediaType === 'movie' && parseInt(state.derived.ageRating) >= 14) || 
                (state.mediaType === 'tv' && state.derived.tvType === 'series' && parseInt(state.derived.ageRating) >= 16))) {
                optionsHTML += `<span>⚠ Pode conter nudez. Considere aplicar a taxa de nudez abaixo.</span>`;
            }
                    
            optionsHTML += `</div>`;

            if (state.derived.isGrito) {
                optionsHTML += `<div class="grito-notice" style="margin-top: 16px;">Conteúdo da franquia "O Grito" - Preço fixo de R$ 15.000,00. Taxas não se aplicam.</div>`;
            }

            optionsHTML += `
                <div class="info-content">
                    <div style="margin-bottom: 8px;"><strong>Estúdios detectados:</strong> <span class="studio-list">${state.derived.productionCompanies.join(', ') || 'Não disponível'}</span></div>
                    <div><strong>Lançado em:</strong> <span class="release-info">${state.derived.releaseDate}</span></div>
                </div>`;
            if (state.mediaType === 'tv') {
                const seasons = state.selectedItem.seasons.filter(s => s.season_number > 0 && s.episode_count > 0);
                const seasonsHTML = seasons.map(s => {
                    return `<option value="${s.season_number}" data-episodes="${s.episode_count}">${s.name} (${s.episode_count} eps)</option>`;
                }).join('');
                optionsHTML += `
                    <div class="config-group">
                        <h3>Temporada</h3>
                        <select id="season-select" class="select-input">${seasonsHTML}</select>
                    </div>`;
                optionsHTML += `
                    <div class="config-group">
                        <h3>Selecionar Episódios</h3>
                        <div class="episode-selector">
                            <p style="margin-bottom: 12px; font-size: 0.9rem; color: var(--text-secondary);">Selecione os episódios que deseja patrocinar (mínimo 3):</p>
                            <div class="episode-scroll-container" id="episodes-list"></div>
                        </div>
                        <div class="discount-notice ${state.derived.discountNotice ? '' : 'hidden'}" style="margin-top: 16px;">${state.derived.discountNotice}</div>
                    </div>`;
            }

            if (!state.derived.isGrito) {
                optionsHTML += `
                    <div class="config-group checkbox-group" style="margin-top: 24px;">
                        <h3 style="margin-top: 16px;">Conteúdo de Risco</h3>`;
                if (state.derived.temNudezEspecial) {
                    state.options.nudez = true;
                    optionsHTML += `<label><input type="checkbox" data-option="nudez" checked disabled class="nudez-checkbox"> Contém Nudez (automático)</label>`;
                    optionsHTML += `<div style="font-size: 0.85rem; color: var(--warning);">Taxa aplicada automaticamente.</div>`;
                } else {
                    if (state.mediaType === 'movie') {
                        optionsHTML += `<label><input type="checkbox" data-option="nudez" ${state.options.nudez ? 'checked' : ''} class="nudez-checkbox"> Contém Nudez (+R$ 15)</label>`;
                    } else {
                        optionsHTML += `<label><input type="checkbox" data-option="nudez" ${state.options.nudez ? 'checked' : ''} class="nudez-checkbox"> Contém Nudez (+R$ 10 POR EP C/ NUDEZ)</label>`;
                    }
                }
                        
                optionsHTML += `</div>`;
                if (state.mediaType === 'tv' && state.options.nudez) {
                    optionsHTML += `
                        <div class="nudez-episodes-config">
                            <h3>Quantos episódios contêm nudez?</h3>
                            <div class="number-input-wrapper">
                                <button class="num-btn" data-action="dec-nudez">-</button>
                                <input type="number" id="nudez-episodes-count" value="${state.options.nudezEpisodes}" min="0" max="${state.options.selectedEpisodes.filter(ep => !ep.alreadySponsored).length}">
                                <button class="num-btn" data-action="inc-nudez">+</button>
                            </div>
                        </div>`;
                }
            }
            
            $('#config-options').innerHTML = optionsHTML;
            if (state.mediaType === 'tv') {
                renderEpisodesList();
            }
            
            $('#change-item').addEventListener('click', resetToSearch);
            if (state.mediaType === 'tv') {
                $('#season-select').addEventListener('change', handleSeasonChange);
                if (!state.derived.isGrito && $('#nudez-episodes-count')) {
                    $('#nudez-episodes-count').addEventListener('input', handleNudezEpisodeInput);
                    $$('[data-action="inc-nudez"], [data-action="dec-nudez"]').forEach(btn => {
                        btn.addEventListener('click', handleNudezEpisodeBtn);
                    });
                }
                handleSeasonChange();
            }
            
            if (!state.derived.isGrito) {
                $$('.checkbox-group input').forEach(cb => {
                    if (!cb.disabled) {
                        cb.addEventListener('change', handleCheckbox);
                    }
                });
            }
        }
        
        function renderEpisodesList() {
            const episodesList = $('#episodes-list');
            episodesList.innerHTML = '';

            const selectedEpisodesMap = new Map(state.options.selectedEpisodes.map(ep => [ep.id, ep]));
            state.derived.seasonEpisodesData.forEach(episode => {
                const selectionInfo = selectedEpisodesMap.get(episode.id);
                const isSelected = !!selectionInfo;
                const isFree = isSelected && selectionInfo.isFree;
                const alreadySponsored = isSelected && selectionInfo.alreadySponsored;

                const episodeItem = document.createElement('div');
                episodeItem.className = 'episode-item';
              
                const freeLabel = isFree ? ` <span style="color: var(--success); font-weight: 500;">(Grátis)</span>` : '';
                const sponsoredLabel = alreadySponsored ? ` <span class="already-sponsored">(Já patrocinado)</span>` : '';
                const disabledAttr = isFree || alreadySponsored ? 'disabled' : '';

                episodeItem.innerHTML = `
                    <input type="checkbox" class="episode-checkbox" data-episode-id="${episode.id}" 
                           data-episode-number="${episode.episode_number}" 
                           data-episode-duration="${episode.runtime || 0}"
                           ${isSelected ? 'checked' : ''} ${disabledAttr}>
                    <div class="episode-info">
                        Episódio ${episode.episode_number}: ${episode.name || 'Sem título'}${freeLabel}${sponsoredLabel}
                    </div>
                    <div class="episode-duration">${formatDuration(episode.runtime)}</div>
                `;
                
                if (!alreadySponsored) {
                    episodeItem.querySelector('.episode-checkbox').addEventListener('change', handleEpisodeSelection);
                }
                
                episodesList.appendChild(episodeItem);
            });
        }

        function updateAndApplyFreeEpisodes() {
            if (state.derived.tvType !== 'anime') return;

            const paidEpisodes = state.options.selectedEpisodes.filter(ep => !ep.isFree && !ep.alreadySponsored);
            const deservedFreeEpisodes = Math.floor(paidEpisodes.length / 11);
            const currentFreeEpisodes = state.options.selectedEpisodes.filter(ep => ep.isFree && !ep.alreadySponsored);
            
            if (currentFreeEpisodes.length > deservedFreeEpisodes) {
                const episodesToRemove = currentFreeEpisodes.slice(deservedFreeEpisodes);
                episodesToRemove.forEach(ep => {
                    state.options.selectedEpisodes = state.options.selectedEpisodes.filter(e => e.id !== ep.id);
                });
            }
            
            if (deservedFreeEpisodes > currentFreeEpisodes.length) {
                const freeEpisodesToAdd = deservedFreeEpisodes - currentFreeEpisodes.length;
                let addedCount = 0;
                
                const paidEpisodeNumbers = paidEpisodes.map(ep => ep.number).sort((a, b) => a - b);
                const lastPaidEpisodeNumber = paidEpisodeNumbers[paidEpisodeNumbers.length - 1] || 0;
                
                for (let i = lastPaidEpisodeNumber + 1; i <= state.derived.seasonEpisodesData.length && addedCount < freeEpisodesToAdd; i++) {
                    const candidateEpisode = state.derived.seasonEpisodesData.find(ep => ep.episode_number === i);
                    if (candidateEpisode) {
                        const isAlreadySelected = state.options.selectedEpisodes.some(ep => ep.id === candidateEpisode.id);
                        if (!isAlreadySelected) {
                            state.options.selectedEpisodes.push({
                                id: candidateEpisode.id,
                                number: candidateEpisode.episode_number,
                                duration: candidateEpisode.runtime || 0,
                                isFree: true,
                                addedAutomatically: true,
                                alreadySponsored: false
                            });
                            addedCount++;
                        }
                    }
                }
            }
        }
        
        function handleEpisodeSelection(e) {
            const checkbox = e.target;
            const episodeId = parseInt(checkbox.dataset.episodeId);
            const episodeNumber = parseInt(checkbox.dataset.episodeNumber);
            const episodeDuration = parseInt(checkbox.dataset.episodeDuration);
            const currentNonSponsoredSelections = state.options.selectedEpisodes.filter(ep => !ep.alreadySponsored);
            const willBeSelected = checkbox.checked;
            
            if (!willBeSelected) {
                const futureNonSponsoredSelections = currentNonSponsoredSelections.filter(ep => ep.id !== episodeId);
                if (futureNonSponsoredSelections.length < 3) {
                    checkbox.checked = true;
                    alert('É necessário selecionar pelo menos 3 episódios.');
                    return;
                }
            }

            if (checkbox.checked) {
                state.options.selectedEpisodes.push({
                    id: episodeId,
                    number: episodeNumber,
                    duration: episodeDuration,
                    isFree: false,
                    addedAutomatically: false,
                    alreadySponsored: false
                });
            } else {
                state.options.selectedEpisodes = state.options.selectedEpisodes.filter(ep => ep.id !== episodeId);
            }
            
            if (state.derived.tvType === 'anime') {
                updateAndApplyFreeEpisodes();
            }
            
            state.options.episodes = state.options.selectedEpisodes.filter(ep => !ep.alreadySponsored).length;
            if (!state.derived.isGrito && $('#nudez-episodes-count')) {
                $('#nudez-episodes-count').max = state.options.episodes;
                if (state.options.nudezEpisodes > state.options.episodes) {
                    state.options.nudezEpisodes = state.options.episodes;
                    $('#nudez-episodes-count').value = state.options.episodes;
                }
            }
            
            renderEpisodesList();
            checkDiscounts();
            calculatePrice();
        }
        
        async function handleSeasonChange() {
            const select = $('#season-select');
            const selectedOption = select.options[select.selectedIndex];
            const seasonNumber = parseInt(select.value);
            state.options.season = seasonNumber;
            state.derived.seasonEpisodes = parseInt(selectedOption.dataset.episodes);
            state.options.selectedEpisodes = [];
            state.options.nudezEpisodes = 0;

            await fetchSeasonDetails();
            state.options.episodes = state.options.selectedEpisodes.filter(ep => !ep.alreadySponsored).length;

            renderEpisodesList();
            checkDiscounts();
            calculatePrice();
        }
        
        function handleNudezEpisodeBtn(e) {
            const input = $('#nudez-episodes-count');
            let value = parseInt(input.value);
            value += e.target.dataset.action === 'inc-nudez' ? 1 : -1;
            
            if (value < 0) value = 0;
            if (value > state.options.selectedEpisodes.filter(ep => !ep.alreadySponsored).length) {
                value = state.options.selectedEpisodes.filter(ep => !ep.alreadySponsored).length;
            }
            
            input.value = value;
            state.options.nudezEpisodes = value;
            calculatePrice();
        }
        
        function handleNudezEpisodeInput() {
            const input = $('#nudez-episodes-count');
            let value = parseInt(input.value) || 0;
            const max = state.options.selectedEpisodes.filter(ep => !ep.alreadySponsored).length;
            if (value < 0) value = 0;
            if (value > max) value = max;
            input.value = value;
            state.options.nudezEpisodes = value;
            calculatePrice();
        }
        
        function checkDiscounts() {
            if (state.derived.isGrito) {
                state.derived.discountNotice = '';
                return;
            }

            state.derived.discountNotice = '';
            if (state.mediaType === 'tv') {
                if (state.derived.tvType === 'series' && 
                    state.derived.listInfo.currentSeasonSponsored === 0 && 
                    state.options.episodes === state.derived.seasonEpisodes) {
                    state.derived.discountNotice = '🎉 15% de desconto pela temporada completa!';
                }
                
                if (state.derived.tvType === 'anime') {
                    const freeEpsCount = state.options.selectedEpisodes.filter(ep => ep.isFree).length;
                    if (freeEpsCount > 0) {
                        state.derived.discountNotice = `🎉 Você ganhou ${freeEpsCount} episódio(s) grátis!`;
                    }
                }
            }
            
            const discountNoticeElement = document.querySelector('.discount-notice');
            if (discountNoticeElement) {
                if (state.derived.discountNotice) {
                    discountNoticeElement.textContent = state.derived.discountNotice;
                    discountNoticeElement.classList.remove('hidden');
                } else {
                    discountNoticeElement.classList.add('hidden');
                }
            }
        }
        
        function handleCheckbox(e) {
            const option = e.target.dataset.option;
            state.options[option] = e.target.checked;
            
            if (option === 'nudez' && !e.target.checked) {
                state.options.nudezEpisodes = 0;
            }
            
            if (option === 'nudez') {
                updateNudezSection();
            } else {
                renderConfigOptions();
            }
            
            calculatePrice();
        }
        
        function updateNudezSection() {
            if (state.mediaType === 'tv' && state.options.nudez) {
                const nudezConfigHTML = `
                    <div class="nudez-episodes-config">
                        <h3>Quantos episódios contêm nudez?</h3>
                        <div class="number-input-wrapper">
                            <button class="num-btn" data-action="dec-nudez">-</button>
                            <input type="number" id="nudez-episodes-count" value="${state.options.nudezEpisodes}" min="0" max="${state.options.selectedEpisodes.filter(ep => !ep.alreadySponsored).length}">
                            <button class="num-btn" data-action="inc-nudez">+</button>
                        </div>
                    </div>`;
                const nudezSection = document.querySelector('.nudez-episodes-config');
                if (nudezSection) {
                    nudezSection.outerHTML = nudezConfigHTML;
                } else {
                    const checkboxGroup = document.querySelector('.checkbox-group');
                    checkboxGroup.insertAdjacentHTML('afterend', nudezConfigHTML);
                }
                
                if ($('#nudez-episodes-count')) {
                    $('#nudez-episodes-count').addEventListener('input', handleNudezEpisodeInput);
                    $$('[data-action="inc-nudez"], [data-action="dec-nudez"]').forEach(btn => {
                        btn.addEventListener('click', handleNudezEpisodeBtn);
                    });
                }
            } else {
                const nudezSection = document.querySelector('.nudez-episodes-config');
                if (nudezSection) {
                    nudezSection.remove();
                }
            }
        }

        function formatDuration(minutes) {
            if (!minutes || minutes === 0) return 'Duração não disponível';
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return hours > 0 ?
                `${hours}h ${mins}m` : `${mins}m`;
        }

        function calculatePrice() {
            let total = 0;
            let breakdownHTML = '';
            const format = (v) => `R$ ${v.toFixed(2).replace('.', ',')}`;
            
            const movieBasePrice = 80;
            const seriesEpPriceShort = 20;
            const seriesEpPriceLong = 40;
            const animeEpPrice = 15;
            const nudezMovieTax = 15;
            const nudezEpisodeTax = 10;
            const extraMinuteTax = 0.50;
            
            const nonSponsoredSelected = state.options.selectedEpisodes.filter(ep => !ep.alreadySponsored);
            const hasNonSponsoredEpisodes = nonSponsoredSelected.length > 0;
            
            if (state.derived.isGrito) {
                total = 15000;
                breakdownHTML += `<p><span>Preço fixo: Franquia O Grito</span><span>${format(total)}</span></p>`;
            } else if (state.mediaType === 'movie') {
                total += movieBasePrice;
                breakdownHTML += `<p><span>Filme (até 2h)</span><span>${format(movieBasePrice)}</span></p>`;
                
                const runtime = state.selectedItem.runtime || 0;
                if (runtime > 120) {
                    const extraMinutes = runtime - 120;
                    const extraCost = extraMinutes * extraMinuteTax;
                    total += extraCost;
                    breakdownHTML += `<p><span>${extraMinutes} minutos extras (1min = R$0,50)</span><span>+${format(extraCost)}</span></p>`;
                }
            } else { 
                let baseCost = 0;
                const sortedEpisodes = [...nonSponsoredSelected].sort((a, b) => a.number - b.number);
                    
                sortedEpisodes.forEach(episode => {
                    if (episode.isFree && state.derived.tvType === 'anime') {
                        breakdownHTML += `<p><span>Ep ${episode.number} (${formatDuration(episode.duration)})</span><span>Grátis</span></p>`;
                        return;
                    }

                    const epDuration = episode.duration || 0;
                    let pricePerEp;
                    
                    if (state.derived.tvType === 'anime') {
                        pricePerEp = epDuration <= 30 ? animeEpPrice : seriesEpPriceLong;
                    } else {
                        pricePerEp = epDuration <= 30 ? seriesEpPriceShort : seriesEpPriceLong;
                    }
    
                    let extraMinutes = 0;
                    if (epDuration > 60) {
                        extraMinutes = epDuration - 60;
                    }
             
                    const extraCost = extraMinutes * extraMinuteTax;
                    const episodeCost = pricePerEp + extraCost;
                    baseCost += episodeCost;
                    
                    breakdownHTML += `<p><span>Ep ${episode.number} (${formatDuration(epDuration)})</span><span>${format(episodeCost)}</span></p>`;
                });

                total += baseCost;
                
                if (state.derived.tvType === 'series' && 
                    state.derived.listInfo.currentSeasonSponsored === 0 && 
                    state.options.episodes === state.derived.seasonEpisodes) {
                    const discount = total * 0.15;
                    total -= discount;
                    breakdownHTML += `<p><span>Desconto Temporada Completa</span><span>-${format(discount)}</span></p>`;
                }
            }
            
            if (!state.derived.isGrito && (state.derived.temNudezEspecial || state.options.nudez)) {
                if (state.mediaType === 'movie') {
                    total += nudezMovieTax;
                    breakdownHTML += `<p style="color: var(--warning);"><span>Taxa Nudez</span><span>+${format(nudezMovieTax)}</span></p>`;
                } else {
                    const nudezCost = state.options.nudezEpisodes * nudezEpisodeTax;
                    total += nudezCost;
                    breakdownHTML += `<p style="color: var(--warning);"><span>Taxa Nudez (${state.options.nudezEpisodes} ep(s))</span><span>+${format(nudezCost)}</span></p>`;
                }
            }
            
            const item = state.selectedItem;
            const infoSep = " ‧ ";
            $('#summary-poster').src = item.poster_path ? IMG_URL + item.poster_path : 'https://via.placeholder.com/80x120/333333/ffffff?text=No+Image';
            $('#summary-title').textContent = item.title || item.name;
            if (state.mediaType === 'movie') {
                $('#summary-info').textContent = `Filme ${infoSep} ${(item.release_date || '').split('-')[0] || 'N/A'} ${infoSep} ${formatDuration(item.runtime)}`;
            } else {
                const totalMinutes = nonSponsoredSelected.reduce((sum, ep) => sum + ep.duration, 0);
                $('#summary-info').textContent = `${state.derived.tvType === 'anime' ? 'Anime' : 'Série'} ${infoSep} ${(item.first_air_date || '').split('-')[0] || 'N/A'} ${infoSep} ${state.options.episodes} episódios selecionados`;
            }
            
            $('#price-breakdown').innerHTML = breakdownHTML;
            $('#total-price').textContent = format(total);
            
            const warningDiv = $('#restriction-warning');
            const payButton = $('#pay-button');
            
            if (state.mediaType === 'tv' && state.derived.listInfo.isCurrentSeasonFullySponsored) {
                payButton.classList.add('disabled');
                payButton.removeAttribute('href');
                warningDiv.textContent = `Esta temporada já foi patrocinada, selecione outra (se disponível) para ver os preços.`;
                warningDiv.classList.remove('hidden');
            } else if (state.mediaType === 'tv' && !hasNonSponsoredEpisodes) {
                payButton.classList.add('disabled');
                payButton.removeAttribute('href');
                warningDiv.textContent = `Não há episódios disponíveis para patrocínio nesta temporada.`;
                warningDiv.classList.remove('hidden');
            } else {
                payButton.classList.remove('disabled');
                payButton.href = `https://livepix.gg/loryez?amount=${total.toFixed(2)}`;
                warningDiv.classList.add('hidden');
            }
        }

        function switchToConfigView() {
            $('#search-block').classList.add('hidden');
            $('#config-block').classList.remove('hidden');
            $('#summary-placeholder').classList.add('hidden');
            $('#summary-content').classList.remove('hidden');
        }

        function resetToSearch() {
            $('#search-input').value = '';
            $('#search-results-list').classList.add('hidden');
            $('#search-results-list').innerHTML = '';
            $('#search-preview').classList.add('hidden');
            $('#search-preview').innerHTML = '';

            $('#search-block').classList.remove('hidden');
            $('#config-block').classList.add('hidden');
            $('#summary-placeholder').classList.remove('hidden');
            $('#summary-content').classList.add('hidden');
            state.derived.discountNotice = '';
            state.options = {
                season: 1, 
                episodes: 3, 
                selectedEpisodes: [],
                nudez: false, 
                nudezEpisodes: 0,
            };
            state.derived.listInfo = {
                loading: false,
                sponsoredEpisodes: 0,
                watchedEpisodes: 0,
                currentSeasonSponsored: 0,
                isCurrentSeasonFullySponsored: false,
                lastSponsoredEpisode: 0,
                hasTemporadas: false,
                temporadasPatrocinadas: [],
                temporadasAssistidas: [],
                totalPatrocinados: 0,
                totalAssistidos: 0
            };
        }

        // --- SCRIPT DAS ABAS E FILTROS ---
        (function() {
            // CORREÇÃO: Lógica de busca e filtro para a aba Assistidos
            const assistidosSearchInput = document.getElementById('assistidos-search-input');
            const assistidosFilterToggleBtn = document.getElementById('assistidos-filter-toggle-btn');
            const assistidosFilterDropdown = document.getElementById('assistidos-filter-dropdown');
            const assistidosFilterOptions = document.querySelectorAll('#assistidos-filter-dropdown .filter-option');
            let currentAssistidosFilter = 'all';

            function applyAssistidosFilter() {
                const query = assistidosSearchInput.value.toLowerCase().trim();
                
                document.querySelectorAll('#assistidos-tab .media-card').forEach(card => {
                    const title = card.querySelector('.media-card-title').textContent.toLowerCase();
                    const type = card.dataset.type;

                    const matchesQuery = title.includes(query);
                    const matchesFilter = (currentAssistidosFilter === 'all' || currentAssistidosFilter === type);
                    
                    card.style.display = (matchesQuery && matchesFilter) ? 'block' : 'none';
                });

                const sections = {
                    filmes: document.getElementById('assistidos-filmes-section'),
                    series: document.getElementById('assistidos-series-section'),
                    animes: document.getElementById('assistidos-animes-section')
                };

                Object.entries(sections).forEach(([key, section]) => {
                    if (currentAssistidosFilter === 'all' || currentAssistidosFilter === key) {
                        const hasVisibleCards = Array.from(section.querySelectorAll('.media-card'))
                            .some(card => card.style.display !== 'none');
                        section.classList.toggle('hidden', !hasVisibleCards);
                    } else {
                        section.classList.add('hidden');
                    }
                });
            }

            assistidosSearchInput.addEventListener('input', applyAssistidosFilter);

            assistidosFilterToggleBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                assistidosFilterDropdown.classList.toggle('hidden');
                assistidosFilterToggleBtn.classList.toggle('active');
            });
            
            document.addEventListener('click', () => {
                assistidosFilterDropdown.classList.add('hidden');
                assistidosFilterToggleBtn.classList.remove('active');
            });

            assistidosFilterOptions.forEach(option => {
                option.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    assistidosFilterOptions.forEach(opt => opt.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    
                    currentAssistidosFilter = e.currentTarget.dataset.filter;
                    assistidosFilterDropdown.classList.add('hidden');
                    assistidosFilterToggleBtn.classList.remove('active');
                    
                    applyAssistidosFilter();
                });
            });

            // CORREÇÃO: Lógica de busca e filtro para a aba Patrocinados
            const sponsoredSearchInput = document.getElementById('sponsored-search-input');
            const filterToggleBtn = document.getElementById('filter-toggle-btn');
            const filterDropdown = document.getElementById('filter-dropdown');
            const filterOptions = document.querySelectorAll('#filter-dropdown .filter-option');
            let currentFilter = 'all';

            function applySponsoredFilter() {
                const query = sponsoredSearchInput.value.toLowerCase().trim();
                
                document.querySelectorAll('#patrocinados-tab .media-card').forEach(card => {
                    const title = card.querySelector('.media-card-title').textContent.toLowerCase();
                    const type = card.dataset.type;

                    const matchesQuery = title.includes(query);
                    const matchesFilter = (currentFilter === 'all' || currentFilter === type);
                    
                    card.style.display = (matchesQuery && matchesFilter) ? 'block' : 'none';
                });

                const sections = {
                    filmes: document.getElementById('filmes-section'),
                    series: document.getElementById('series-section'),
                    animes: document.getElementById('animes-section')
                };

                Object.entries(sections).forEach(([key, section]) => {
                    if (currentFilter === 'all' || currentFilter === key) {
                        const hasVisibleCards = Array.from(section.querySelectorAll('.media-card'))
                            .some(card => card.style.display !== 'none');
                        section.classList.toggle('hidden', !hasVisibleCards);
                    } else {
                        section.classList.add('hidden');
                    }
                });
            }

            sponsoredSearchInput.addEventListener('input', applySponsoredFilter);

            filterToggleBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                filterDropdown.classList.toggle('hidden');
                filterToggleBtn.classList.toggle('active');
            });
            
            document.addEventListener('click', () => {
                filterDropdown.classList.add('hidden');
                filterToggleBtn.classList.remove('active');
            });

            filterOptions.forEach(option => {
                option.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    filterOptions.forEach(opt => opt.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    
                    currentFilter = e.currentTarget.dataset.filter;
                    filterDropdown.classList.add('hidden');
                    filterToggleBtn.classList.remove('active');
                    
                    applySponsoredFilter();
                });
            });

        })();

        // --- SCRIPT PARA CARREGAR CONTEÚDOS PATROCINADOS E ASSISTIDOS ---
        
        // FUNÇÃO DE RENDERIZAR ERRO COM BOTÃO
        function renderErrorButton(containerId, retryFunction) {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="error-container">
                    <p>Erro ao carregar as informações. Verifique sua conexão.</p>
                    <button class="retry-btn">Tentar Novamente</button>
                </div>
            `;
            container.classList.remove('hidden');
            const btn = container.querySelector('.retry-btn');
            btn.onclick = function() {
                container.innerHTML = 'Carregando...';
                retryFunction();
            };
        }

        const TMDB_API_KEY = 'ae110c8706fa5b6ed0a58125648e31b3';
        const TMDB_BASE_URL = 'https://api.themoviedb.org/3';
        const TMDB_IMG_URL = 'https://image.tmdb.org/t/p/w500';

        let sponsoredDataCache = [];
        let assistidosDataCache = [];
        
        // Lógica para fechar os modais
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal || e.target.closest('.modal-close')) {
                    modal.classList.remove('visible');
                }
            });
        });

        function renderStars(rating) {
            if (!rating || rating === '') {
                return '<span class="no-rating">Sem avaliação</span>';
            }
            
            const numericRating = parseFloat(rating);
            if (isNaN(numericRating)) {
                return '<span class="no-rating">Sem avaliação</span>';
            }
            
            const fullStars = Math.floor(numericRating);
            const hasHalfStar = numericRating % 1 >= 0.5;
            const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
            
            let starsHTML = '';
            
            for (let i = 0; i < fullStars; i++) {
                starsHTML += '<span class="star filled">★</span>';
            }
            
            if (hasHalfStar) {
                starsHTML += '<span class="star half">★</span>';
            }
            
            for (let i = 0; i < emptyStars; i++) {
                starsHTML += '<span class="star">★</span>';
            }
            
            return starsHTML;
        }

        function populateInfoTags(containerId, dataString) {
            const container = document.getElementById(containerId);
            container.innerHTML = ''; 
            if (dataString && dataString.toString().trim() !== "") {
                const parts = dataString.toString().split('|');
                parts.forEach(part => {
                    if (part.trim() !== "") {
                        const tag = document.createElement('span');
                        tag.className = 'info-tag';
                        tag.textContent = part.trim();
                        container.appendChild(tag);
                    }
                });
            } else {
                const tag = document.createElement('span');
                tag.className = 'info-tag';
                tag.textContent = 'N/A';
                container.appendChild(tag);
            }
        }

        // Carrega e processa os dados da planilha e do TMDB para PATROCINADOS
        async function loadSponsoredContent() {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 8000);

                const response = await fetch(SPONSORED_DATA_URL, { signal: controller.signal });
                clearTimeout(timeoutId);

                if (!response.ok) throw new Error('Falha ao buscar dados do Google Script.');
                const sponsoredItems = await response.json();
                
                const detailedItems = await Promise.all(
                    sponsoredItems.map(async (item) => {
                        const tmdbId = item['ID DO TMDB'];
                        if (!tmdbId) return null;

                        const isMovie = !item['Episódios Patrocinados'] && !item['Episódios Assistidos'];
                        const mediaType = isMovie ? 'movie' : 'tv';
                        
                        const tmdbUrl = `${TMDB_BASE_URL}/${mediaType}/${tmdbId}?api_key=${TMDB_API_KEY}&language=pt-BR`;
                        
                        try {
                            const tmdbResponse = await fetch(tmdbUrl);
                            if (!tmdbResponse.ok) return null;
                            const tmdbData = await tmdbResponse.json();
                            return { ...item, ...tmdbData, media_type_custom: mediaType };
                        } catch (e) {
                            return null;
                        }
                    })
                );
                
                document.getElementById('loading-message').classList.add('hidden');
                renderSponsoredContent(detailedItems.filter(item => item !== null));

            } catch (error) {
                console.error('Erro ao carregar conteúdo patrocinado:', error);
                renderErrorButton('loading-message', loadSponsoredContent);
            }
        }
        
        function renderSponsoredContent(items) {
            const containers = {
                filmes: document.getElementById('filmes-grid'),
                series: document.getElementById('series-grid'),
                animes: document.getElementById('animes-grid')
            };

            const sections = {
                filmes: document.getElementById('filmes-section'),
                series: document.getElementById('series-section'),
                animes: document.getElementById('animes-section')
            };

            containers.filmes.innerHTML = '';
            containers.series.innerHTML = '';
            containers.animes.innerHTML = '';

            items.forEach(item => {
                sponsoredDataCache.push(item);
                
                const card = document.createElement('div');
                card.className = 'media-card';
                card.dataset.id = item.id;
                
                const posterPath = item.poster_path ? `${TMDB_IMG_URL}${item.poster_path}` : 'https://via.placeholder.com/200x300?text=Sem+Imagem';
                
                card.innerHTML = `
                    <img src="${posterPath}" alt="Pôster de ${item.title || item.name}">
                    <div class="media-card-title">${item.title || item.name}</div>
                `;

                let typeKey;
                if (item.media_type_custom === 'movie') {
                    typeKey = 'filmes';
                    sections.filmes.classList.remove('hidden');
                    containers.filmes.appendChild(card);
                } else { 
                    const isAnime = item.genres && item.genres.some(genre => genre.id === 16);
                    if (isAnime) {
                        typeKey = 'animes';
                        sections.animes.classList.remove('hidden');
                        containers.animes.appendChild(card);
                    } else {
                        typeKey = 'series';
                        sections.series.classList.remove('hidden');
                        containers.series.appendChild(card);
                    }
                }
                card.dataset.type = typeKey;

                card.addEventListener('click', () => showSponsoredDetailsModal(item.id));
            });
        }

        function showSponsoredDetailsModal(tmdbId) {
            const item = sponsoredDataCache.find(data => data.id == tmdbId);
            if (!item) return;

            const backdrop = item.backdrop_path ? `${BACKDROP_URL}${item.backdrop_path}` : '';
            const backdropBg = document.querySelector('#details-modal .modal-backdrop-bg');
            if (backdropBg) {
                backdropBg.style.backgroundImage = `url('${backdrop}')`;
            }

            document.getElementById('modal-poster').src = item.poster_path ?
                `${TMDB_IMG_URL}${item.poster_path}` : 'https://via.placeholder.com/200x300?text=Sem+Imagem';
            document.getElementById('modal-title').textContent = item.title || item.name;
            document.getElementById('modal-synopsis').textContent = item.overview || 'Sinopse não disponível.';
            
            const subtitleEl = document.getElementById('modal-subtitle');
            const bodySponsorContainer = document.getElementById('modal-sponsor-container-body');
            
            if (item.media_type_custom === 'movie') {
                subtitleEl.innerHTML = item.Patrocinador ? `Patrocinado por <span style="color: #fff; font-weight: 700;">${item.Patrocinador}</span>` : '';
                bodySponsorContainer.classList.add('hidden');
            } else {
                subtitleEl.textContent = '';
                bodySponsorContainer.classList.remove('hidden');
                populateInfoTags('modal-sponsor', item.Patrocinador);
            }

            const metaContainer = document.getElementById('modal-meta');
            metaContainer.innerHTML = '';

            document.getElementById('modal-info-tv').classList.toggle('hidden', item.media_type_custom === 'movie');
            document.getElementById('modal-genres-container').classList.toggle('hidden', item.media_type_custom !== 'movie');
            
            if (item.media_type_custom === 'movie') {
                const year = item.release_date ? item.release_date.split('-')[0] : 'N/A';
                metaContainer.innerHTML = `
                    <span>Filme</span>
                    <span>${year}</span>
                    <span>${formatDuration(item.runtime)}</span>
                `;
                const genresContainer = document.getElementById('modal-genres');
                if (item.genres) {
                    genresContainer.innerHTML = item.genres.slice(0, 3).map(g => `<span>${g.name}</span>`).join('');
                }
            } else {
                const type = item.genres && item.genres.some(g => g.id === 16) ? 'Anime' : 'Série';
                const year = item.first_air_date ? item.first_air_date.split('-')[0] : 'N/A';
                metaContainer.innerHTML = `
                    <span>${type}</span>
                    <span>${year}</span>
                `;

                const totalEpsGroup = document.getElementById('modal-total-eps-group');
                if (item['Episódios Totais'] && item['Episódios Totais'].toString().trim() !== '') {
                    populateInfoTags('modal-total-eps', item['Episódios Totais']);
                    totalEpsGroup.classList.remove('hidden');
                } else {
                    totalEpsGroup.classList.add('hidden');
                }
                
                populateInfoTags('modal-sponsored-eps', item['Episódios Patrocinados']);
                populateInfoTags('modal-watched-eps', item['Episódios Assistidos']);
            }

            document.getElementById('details-modal').classList.add('visible');
        }

        // Carrega e processa os dados da planilha e do TMDB para ASSISTIDOS
        async function loadAssistidosContent() {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 8000);

                const response = await fetch(ASSISTIDOS_DATA_URL, { signal: controller.signal });
                clearTimeout(timeoutId);

                if (!response.ok) throw new Error('Falha ao buscar dados do Google Script.');
                const assistidosItems = await response.json();
                
                const detailedItems = await Promise.all(
                    assistidosItems.map(async (item) => {
                        const tmdbId = item['ID DO TMDB'];
                        if (!tmdbId) return null;

                        const isMovie = !item['Episódios Patrocinados'] && !item['Episódios Assistidos '];
                        const mediaType = isMovie ? 'movie' : 'tv';
                        
                        const tmdbUrl = `${TMDB_BASE_URL}/${mediaType}/${tmdbId}?api_key=${TMDB_API_KEY}&language=pt-BR`;
                        
                        try {
                            const tmdbResponse = await fetch(tmdbUrl);
                            if (!tmdbResponse.ok) return null;
                            const tmdbData = await tmdbResponse.json();
                            return { ...item, ...tmdbData, media_type_custom: mediaType };
                        } catch (e) {
                            return null;
                        }
                    })
                );
                
                document.getElementById('assistidos-loading-message').classList.add('hidden');
                renderAssistidosContent(detailedItems.filter(item => item !== null));

            } catch (error) {
                console.error('Erro ao carregar conteúdo assistido:', error);
                renderErrorButton('assistidos-loading-message', loadAssistidosContent);
            }
        }
        
        function renderAssistidosContent(items) {
            const containers = {
                filmes: document.getElementById('assistidos-filmes-grid'),
                series: document.getElementById('assistidos-series-grid'),
                animes: document.getElementById('assistidos-animes-grid')
            };

            const sections = {
                filmes: document.getElementById('assistidos-filmes-section'),
                series: document.getElementById('assistidos-series-section'),
                animes: document.getElementById('assistidos-animes-section')
            };

            containers.filmes.innerHTML = '';
            containers.series.innerHTML = '';
            containers.animes.innerHTML = '';

            items.forEach(item => {
                assistidosDataCache.push(item);
                
                const card = document.createElement('div');
                card.className = 'media-card';
                card.dataset.id = item.id;
                
                const posterPath = item.poster_path ? `${TMDB_IMG_URL}${item.poster_path}` : 'https://via.placeholder.com/200x300?text=Sem+Imagem';
                
                card.innerHTML = `
                    <img src="${posterPath}" alt="Pôster de ${item.Título}">
                    <div class="media-card-title">${item.Título}</div>
                `;

                let typeKey;
                if (item.media_type_custom === 'movie') {
                    typeKey = 'filmes';
                    sections.filmes.classList.remove('hidden');
                    containers.filmes.appendChild(card);
                } else { 
                    const isAnime = item.genres && item.genres.some(genre => genre.id === 16);
                    if (isAnime) {
                        typeKey = 'animes';
                        sections.animes.classList.remove('hidden');
                        containers.animes.appendChild(card);
                    } else {
                        typeKey = 'series';
                        sections.series.classList.remove('hidden');
                        containers.series.appendChild(card);
                    }
                }
                card.dataset.type = typeKey;

                card.addEventListener('click', () => showAssistidosDetailsModal(item.id));
            });
        }

        function showAssistidosDetailsModal(tmdbId) {
            const item = assistidosDataCache.find(data => data.id == tmdbId);
            if (!item) return;

            const backdrop = item.backdrop_path ? `${BACKDROP_URL}${item.backdrop_path}` : '';
            const backdropBg = document.querySelector('#assistidos-details-modal .modal-backdrop-bg');
            if (backdropBg) {
                backdropBg.style.backgroundImage = `url('${backdrop}')`;
            }

            document.getElementById('assistidos-modal-poster').src = item.poster_path ?
                `${TMDB_IMG_URL}${item.poster_path}` : 'https://via.placeholder.com/200x300?text=Sem+Imagem';
            document.getElementById('assistidos-modal-title').textContent = item.Título;
            document.getElementById('assistidos-modal-synopsis').textContent = item.overview || 'Sinopse não disponível.';
            document.getElementById('assistidos-modal-rating').innerHTML = renderStars(item['Nota da Lorena']);
            
            const subtitleEl = document.getElementById('assistidos-modal-subtitle');
            const bodySponsorContainer = document.getElementById('assistidos-modal-sponsor-container-body');
            
            if (item.media_type_custom === 'movie') {
                subtitleEl.innerHTML = item.Patrocinador ? `Patrocinado por <span style="color: #fff; font-weight: 700;">${item.Patrocinador}</span>` : '';
                bodySponsorContainer.classList.add('hidden');
            } else {
                subtitleEl.textContent = '';
                bodySponsorContainer.classList.remove('hidden');
                populateInfoTags('assistidos-modal-sponsor', item.Patrocinador);
            }

            const metaContainer = document.getElementById('assistidos-modal-meta');
            metaContainer.innerHTML = '';

            document.getElementById('assistidos-modal-info-tv').classList.toggle('hidden', item.media_type_custom === 'movie');
            document.getElementById('assistidos-modal-genres-container').classList.toggle('hidden', item.media_type_custom !== 'movie');
            
            if (item.media_type_custom === 'movie') {
                const year = item.release_date ? item.release_date.split('-')[0] : 'N/A';
                metaContainer.innerHTML = `
                    <span>Filme</span>
                    <span>${year}</span>
                    <span>${formatDuration(item.runtime)}</span>
                `;
                const genresContainer = document.getElementById('assistidos-modal-genres');
                if (item.genres) {
                    genresContainer.innerHTML = item.genres.slice(0, 3).map(g => `<span>${g.name}</span>`).join('');
                }
            } else {
                const type = item.genres && item.genres.some(g => g.id === 16) ? 'Anime' : 'Série';
                const year = item.first_air_date ? item.first_air_date.split('-')[0] : 'N/A';
                metaContainer.innerHTML = `
                    <span>${type}</span>
                    <span>${year}</span>
                `;
                populateInfoTags('assistidos-modal-sponsored-eps', item['Episódios Patrocinados']);
                populateInfoTags('assistidos-modal-watched-eps', item['Episódios Assistidos ']);
            }

            document.getElementById('assistidos-details-modal').classList.add('visible');
        }

        // INICIA TUDO
        init();
    </script>
</body>
</html>
